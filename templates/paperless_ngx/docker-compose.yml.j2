version: '3.8'

services:
  paperless:
    image: {{ paperless_ngx_image }}
    container_name: {{ paperless_ngx_container_name }}
    restart: {{ paperless_ngx_restart_policy }}
    environment:
      - PUID={{ ansible_user_id | default(1000) }}
      - PGID={{ ansible_user_gid | default(1000) }}
      - TZ={{ timezone | default('UTC') }}
      - PAPERLESS_REDIS=redis://{{ paperless_ngx_redis_host }}:{{ paperless_ngx_redis_port }}/{{ paperless_ngx_redis_db }}
      - PAPERLESS_DBHOST={{ paperless_ngx_database_host }}
      - PAPERLESS_DBNAME={{ paperless_ngx_database_name }}
      - PAPERLESS_DBUSER={{ paperless_ngx_database_user }}
      - PAPERLESS_DBPASS={{ paperless_ngx_database_password }}
      - PAPERLESS_SECRET_KEY={{ paperless_ngx_secret_key }}
      - PAPERLESS_URL=https://{{ paperless_ngx_domain }}
    volumes:
      - {{ docker_root }}/paperless/data:/usr/src/paperless/data
      - {{ docker_root }}/paperless/media:/usr/src/paperless/media
      - {{ docker_root }}/paperless/export:/usr/src/paperless/export
      - {{ docker_root }}/paperless/consume:/usr/src/paperless/consume
    ports:
      - "{{ paperless_ngx_web_port }}:8000"
    networks:
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.paperless.rule=Host(`{{ paperless_ngx_domain }}`)"
      - "traefik.http.routers.paperless.entrypoints=websecure"
      - "traefik.http.routers.paperless.tls=true"
      - "traefik.http.routers.paperless.tls.certresolver=cloudflare"
      - "traefik.http.services.paperless.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.paperless-auth.forwardauth.address=http://authentik:9000/outpost.goauthentik.io/auth/traefik"
      - "traefik.http.middlewares.paperless-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.routers.paperless.middlewares=paperless-auth"
      - "traefik.http.middlewares.paperless-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.paperless-headers.headers.customrequestheaders.X-Forwarded-Host={{ paperless_ngx_domain }}"
      - "traefik.http.routers.paperless.middlewares=paperless-headers"
      # Loki/Promtail scraping labels
      - "logging=promtail"
      - "promtail-job=paperless"
      - "promtail-service=paperless-ngx"
    depends_on:
      - paperless-db
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://{{ ansible_default_ipv4.address }}:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  paperless-db:
    image: postgres:15
    container_name: paperless-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB={{ paperless_ngx_database_name }}
      - POSTGRES_USER={{ paperless_ngx_database_user }}
      - POSTGRES_PASSWORD={{ paperless_ngx_database_password }}
    volumes:
      - {{ docker_root }}/paperless/database:/var/lib/postgresql/data
    networks:
      - traefik_network

  redis:
    image: redis:7
    container_name: paperless-redis
    restart: unless-stopped
    volumes:
      - {{ docker_root }}/paperless/redis:/data
    networks:
      - traefik_network

networks:
  traefik_network:
    external: true 