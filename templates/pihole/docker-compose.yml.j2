version: '3.8'

services:
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    environment:
      TZ: '{{ timezone | default("UTC") }}'
      WEBPASSWORD: '{{ pihole_web_password }}'
      VIRTUAL_HOST: '{{ pihole_domain | default("pihole." + domain) }}'
      PROXY_LOCATION: pihole
      ServerIP: '{{ ansible_default_ipv4.address }}'
      DNS1: '{{ pihole_upstream_dns[0] | default("1.1.1.1") }}'
      DNS2: '{{ pihole_upstream_dns[1] | default("1.0.0.1") }}'
      DNSMASQ_LISTENING: all
      REV_SERVER: '{{ pihole_rev_server | default(false) }}'
      REV_SERVER_DOMAIN: '{{ pihole_rev_server_domain | default("") }}'
      REV_SERVER_TARGET: '{{ pihole_rev_server_target | default("") }}'
      REV_SERVER_CIDR: '{{ pihole_rev_server_cidr | default("") }}'
    volumes:
      - '{{ docker_data_root }}/pihole/etc-pihole:/etc/pihole'
      - '{{ docker_data_root }}/pihole/etc-dnsmasq.d:/etc/dnsmasq.d'
      - '{{ docker_data_root }}/pihole/logs:/var/log'
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
    restart: unless-stopped
    networks:
      - traefik_network
      - pihole_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`{{ pihole_domain | default('pihole.' + domain) }}`)"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.tls=true"
      - "traefik.http.routers.pihole.tls.certresolver=letsencrypt"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
      - "traefik.http.routers.pihole.middlewares=authelia@file"
      # Loki/Promtail scraping labels
      - "logging=promtail"
      - "promtail-job=security"
      - "promtail-service=pihole"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://{{ ansible_default_ipv4.address }}:80/admin/api.php?status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  traefik_network:
    external: true
  pihole_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16 