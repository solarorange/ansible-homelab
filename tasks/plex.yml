---
# Plex Configuration
# Existing Plex Server Integration

- name: Create Plex Traefik configuration
  ansible.builtin.copy:
    dest: "{{ docker_dir }}/traefik/dynamic/plex.yml"
    content: |
      http:
        routers:
          plex:
            rule: "Host(`plex.{{ domain }}`)"
            service: plex
            entryPoints:
              - websecure
            middlewares:
              - plex-auth
              - plex-headers
            tls:
              certResolver: cloudflare

        services:
          plex:
            loadBalancer:
              servers:
                - url: "http://{{ ansible_default_ipv4.address }}:32400"

        middlewares:
          plex-auth:
            forwardAuth:
              address: "http://authentik:9000/outpost.goauthentik.io/auth/traefik"
              trustForwardHeader: true
              authResponseHeaders:
                - X-authentik-username
                - X-authentik-groups
                - X-authentik-email
                - X-authentik-name
                - X-authentik-uid
                - X-authentik-jwt
                - X-authentik-meta-jwks
                - X-authentik-meta-outpost
                - X-authentik-meta-provider
                - X-authentik-meta-app
                - X-authentik-meta-app-jwks

          plex-headers:
            headers:
              customRequestHeaders:
                X-Forwarded-Proto: "https"
                X-Forwarded-Host: "plex.{{ domain }}"
              sslRedirect: true
              forceSTSHeader: true
              stsIncludeSubdomains: true
              stsPreload: true
              stsSeconds: 31536000
              customFrameOptionsValue: "SAMEORIGIN"
              contentTypeNosniff: true
              browserXssFilter: true
              referrerPolicy: "strict-origin-when-cross-origin"
              permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0640"

- name: Add Plex to homepage bookmarks
  ansible.builtin.blockinfile:
    path: "{{ docker_dir }}/homepage/config/bookmarks.yml"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Plex"
    block: |
      - "[Plex](https://plex.{{ domain }})"
    insertafter: "Media:"
    insertbefore: "  - Streaming:"
