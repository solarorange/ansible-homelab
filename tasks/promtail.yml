---
# Promtail Configuration
# Production-ready log collection agent

- name: Create Promtail directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"
  loop:
    - "{{ docker_dir }}/monitoring/promtail/config"
    - "{{ docker_dir }}/monitoring/promtail/scripts"
    - "{{ logs_dir }}/monitoring/promtail"

- name: Create Promtail configuration
  ansible.builtin.copy:
    dest: "{{ docker_dir }}/monitoring/promtail/config/promtail.yml"
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://loki:3100/loki/api/v1/push

      scrape_configs:
        - job_name: system
          static_configs:
            - targets:
                - {{ ansible_default_ipv4.address }}
              labels:
                job: varlogs
                __path__: /var/log/*log
                host: {{ inventory_hostname }}

        - job_name: docker
          static_configs:
            - targets:
                - {{ ansible_default_ipv4.address }}
              labels:
                job: docker
                __path__: /var/lib/docker/containers/*/*-json.log
                host: {{ inventory_hostname }}

        - job_name: journal
          journal:
            max_age: 12h
            labels:
              job: systemd-journal
              host: {{ inventory_hostname }}

        - job_name: monitoring
          static_configs:
            - targets:
                - {{ ansible_default_ipv4.address }}
              labels:
                job: monitoring
                __path__: /var/log/monitoring/*.log
                host: {{ inventory_hostname }}

        - job_name: applications
          static_configs:
            - targets:
                - {{ ansible_default_ipv4.address }}
              labels:
                job: applications
                __path__: /var/log/applications/*.log
                host: {{ inventory_hostname }}
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0640"

- name: Create Promtail management script
  ansible.builtin.copy:
    dest: "{{ docker_dir }}/monitoring/promtail/scripts/manage.sh"
    content: |
      #!/bin/bash

      # Promtail Management Script

      function show_help {
        echo "Promtail Management Script"
        echo "Usage: $0 [command]"
        echo ""
        echo "Commands:"
        echo "  status    - Show Promtail status"
        echo "  logs      - Show Promtail logs"
        echo "  restart   - Restart Promtail"
        echo "  config    - Show current config"
        echo "  help      - Show this help"
      }

      case "$1" in
        status)
          curl -s http://{{ ansible_default_ipv4.address }}:/ready
          ;;
        logs)
          docker logs promtail --tail 100 -f
          ;;
        restart)
          docker restart promtail
          ;;
        config)
          cat {{ docker_dir }}/monitoring/promtail/config/promtail.yml
          ;;
        help|*)
          show_help
          ;;
      esac
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0750"

- name: Create Promtail health check script
  ansible.builtin.copy:
    dest: "{{ docker_dir }}/monitoring/promtail/scripts/healthcheck.sh"
    content: |
      #!/bin/bash

      # Check if Promtail is responding
      if ! curl -s http://{{ ansible_default_ipv4.address }}:/ready > /dev/null; then
        echo "Promtail is not responding"
        exit 1
      fi

      # Check if we can access metrics
      if ! curl -s http://{{ ansible_default_ipv4.address }}:/metrics > /dev/null; then
        echo "Promtail metrics endpoint is not responding"
        exit 1
      fi

      exit 0
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0750"

- name: Create Promtail log rotation configuration
  ansible.builtin.copy:
    dest: "{{ docker_dir }}/monitoring/promtail/config/logrotate.conf"
    content: |
      {{ logs_dir }}/monitoring/promtail/*.log {
        daily
        rotate 7
        compress
        delaycompress
        missingok
        notifempty
        create 0640 {{ username }} {{ username }}
      }
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0640"

- name: Add Promtail log rotation to crontab
  ansible.builtin.cron:
    name: "Rotate Promtail logs"
    job: "logrotate {{ docker_dir }}/monitoring/promtail/config/logrotate.conf"
    hour: "0"
    minute: "0"
    user: "{{ vault_promtail_user }}"
