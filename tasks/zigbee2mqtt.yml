---
- name: Create Zigbee2MQTT directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "{{ docker_data_root }}/zigbee2mqtt"
    - "{{ docker_data_root }}/zigbee2mqtt/data"

- name: Create Zigbee2MQTT configuration file
  copy:
    dest: "{{ docker_data_root }}/zigbee2mqtt/data/configuration.yaml"
    content: |
      homeassistant: true
      permit_join: false
      mqtt:
        server: mqtt://mosquitto:1883
        user: zigbee2mqtt
        password: {{ zigbee2mqtt_mqtt_password }}
      serial:
        port: /dev/ttyACM0
      frontend:
        port: 8080
      advanced:
        log_level: info
        pan_id: 6754
        channel: 11
        network_key:
          - 1
          - 3
          - 5
          - 7
          - 9
          - 11
          - 13
          - 15
          - 0
          - 2
          - 4
          - 6
          - 8
          - 10
          - 12
          - 13

- name: Create Zigbee2MQTT docker-compose service
  blockinfile:
    path: "{{ docker_compose_file }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Zigbee2MQTT"
    block: |
      zigbee2mqtt:
        image: koenkk/zigbee2mqtt:latest
        container_name: zigbee2mqtt
        volumes:
          - {{ docker_data_root }}/zigbee2mqtt/data:/app/data
          - /dev:/dev
        ports:
          - "8080:8080"
        environment:
          - TZ={{ timezone }}
        restart: unless-stopped
        privileged: true
        devices:
          - /dev/ttyACM0:/dev/ttyACM0
        networks:
          - traefik_network
        depends_on:
          - mosquitto

- name: Create Zigbee2MQTT health check script
  copy:
    dest: "{{ scripts_dir }}/health_check_zigbee2mqtt.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      if ! curl -s -f "http://localhost:8080" > /dev/null; then
        echo "Zigbee2MQTT frontend is not responding"
        exit 1
      fi
      exit 0

- name: Create Zigbee2MQTT backup script
  copy:
    dest: "{{ scripts_dir }}/backup_zigbee2mqtt.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      BACKUP_DIR="{{ backup_root }}/zigbee2mqtt"
      mkdir -p "$BACKUP_DIR"
      tar -czf "$BACKUP_DIR/zigbee2mqtt_$(date +%Y%m%d_%H%M%S).tar.gz" -C {{ docker_data_root }}/zigbee2mqtt data

- name: Add Zigbee2MQTT backup to crontab
  cron:
    name: "Backup Zigbee2MQTT"
    job: "{{ scripts_dir }}/backup_zigbee2mqtt.sh"
    hour: "2"
    minute: "30"
    state: present

- name: Create Zigbee2MQTT log rotation configuration
  copy:
    dest: /etc/logrotate.d/zigbee2mqtt
    content: |
      {{ docker_data_root }}/zigbee2mqtt/data/log.txt {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          create 0640 root root
      } 