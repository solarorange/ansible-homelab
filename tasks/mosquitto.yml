---
- name: Create Mosquitto directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "{{ docker_data_root }}/mosquitto"
    - "{{ docker_data_root }}/mosquitto/config"
    - "{{ docker_data_root }}/mosquitto/data"
    - "{{ docker_data_root }}/mosquitto/log"

- name: Create Mosquitto configuration file
  copy:
    dest: "{{ docker_data_root }}/mosquitto/config/mosquitto.conf"
    content: |
      persistence true
      persistence_location /mosquitto/data/
      log_dest file /mosquitto/log/mosquitto.log
      log_dest stdout
      listener 1883
      allow_anonymous false
      password_file /mosquitto/config/passwd
      acl_file /mosquitto/config/acl

- name: Create Mosquitto ACL file
  copy:
    dest: "{{ docker_data_root }}/mosquitto/config/acl"
    content: |
      # Default deny
      pattern readwrite #

      # Allow Home Assistant full access
      user homeassistant
      pattern readwrite #

      # Allow Zigbee2MQTT full access
      user zigbee2mqtt
      pattern readwrite #

- name: Create Mosquitto docker-compose service
  blockinfile:
    path: "{{ docker_compose_file }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Mosquitto"
    block: |
      mosquitto:
        image: eclipse-mosquitto:latest
        container_name: mosquitto
        volumes:
          - {{ docker_data_root }}/mosquitto/config:/mosquitto/config
          - {{ docker_data_root }}/mosquitto/data:/mosquitto/data
          - {{ docker_data_root }}/mosquitto/log:/mosquitto/log
        ports:
          - "1883:1883"
          - "9001:9001"
        restart: unless-stopped
        networks:
          - traefik_network

- name: Create Mosquitto health check script
  copy:
    dest: "{{ scripts_dir }}/health_check_mosquitto.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      if ! nc -z {{ ansible_default_ipv4.address }} 1883; then
        echo "Mosquitto is not responding on port 1883"
        exit 1
      fi
      exit 0

- name: Create Mosquitto backup script
  copy:
    dest: "{{ scripts_dir }}/backup_mosquitto.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      BACKUP_DIR="{{ backup_root }}/mosquitto"
      mkdir -p "$BACKUP_DIR"
      tar -czf "$BACKUP_DIR/mosquitto_$(date +%Y%m%d_%H%M%S).tar.gz" -C {{ docker_data_root }}/mosquitto config data

- name: Add Mosquitto backup to crontab
  cron:
    name: "Backup Mosquitto"
    job: "{{ scripts_dir }}/backup_mosquitto.sh"
    hour: "2"
    minute: "15"
    state: present

- name: Create Mosquitto log rotation configuration
  copy:
    dest: /etc/logrotate.d/mosquitto
    content: |
      {{ docker_data_root }}/mosquitto/log/mosquitto.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          create 0640 root root
      } 