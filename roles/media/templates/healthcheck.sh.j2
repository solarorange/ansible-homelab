#!/bin/bash
# Media Stack Health Check Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# Configuration
LOG_FILE="{{ media_health_check_log_file }}"
MAX_LOG_SIZE="{{ media_health_check_max_log_size | default('10M') }}"
RETENTION_DAYS="{{ media_health_check_retention_days | default(7) }}"
TIMEOUT="{{ media_health_check_timeout | default(30) }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Health check function
check_service() {
    local service_name="$1"
    local url="$2"
    local expected_status="${3:-200}"
    local timeout="${4:-$TIMEOUT}"
    
    log "Checking $service_name..."
    
    if curl -f -s --max-time "$timeout" "$url" > /dev/null 2>&1; then
        log "${GREEN}✓ $service_name is healthy${NC}"
        return 0
    else
        log "${RED}✗ $service_name is unhealthy${NC}"
        return 1
    fi
}

# Check Docker containers
check_container() {
    local container_name="$1"
    local service_name="$2"
    
    log "Checking container $container_name..."
    
    if docker ps --format "table {{.Names}}" | grep -q "^$container_name$"; then
        if docker inspect "$container_name" --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
            log "${GREEN}✓ $service_name container is healthy${NC}"
            return 0
        else
            log "${YELLOW}⚠ $service_name container is running but health check failed${NC}"
            return 1
        fi
    else
        log "${RED}✗ $service_name container is not running${NC}"
        return 1
    fi
}

# Main health check function
main() {
    local failed_checks=0
    local total_checks=0
    
    log "Starting media stack health check..."
    
    # Create log directory if it doesn't exist
    mkdir -p "$(dirname "$LOG_FILE")"
    
    # Rotate log if it's too large
    if [ -f "$LOG_FILE" ] && [ "$(stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)" -gt "$(numfmt --from=iec "$MAX_LOG_SIZE")" ]; then
        mv "$LOG_FILE" "${LOG_FILE}.old"
        log "Rotated log file"
    fi
    
    # Clean up old logs
    find "$(dirname "$LOG_FILE")" -name "*.old" -mtime +$RETENTION_DAYS -delete 2>/dev/null || true
    
{% if media_enable_downloaders %}
    # Check downloaders
{% if media_enable_sabnzbd %}
    ((total_checks++))
    if check_service "SABnzbd" "http://localhost:{{ media_sabnzbd_port }}/api?mode=version&apikey={{ media_sabnzbd_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_sabnzbd_container_name }}" "SABnzbd"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_qbittorrent %}
    ((total_checks++))
    if check_service "qBittorrent" "http://localhost:{{ media_qbittorrent_port }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_qbittorrent_container_name }}" "qBittorrent"; then
        ((failed_checks++))
    fi
{% endif %}
{% endif %}
{% if media_enable_arr_services %}
    # Check ARR services
{% if media_enable_sonarr %}
    ((total_checks++))
    if check_service "Sonarr" "http://localhost:{{ media_sonarr_port }}/api/v3/system/status?apikey={{ media_sonarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_sonarr_container_name }}" "Sonarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_radarr %}
    ((total_checks++))
    if check_service "Radarr" "http://localhost:{{ media_radarr_port }}/api/v3/system/status?apikey={{ media_radarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_radarr_container_name }}" "Radarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_lidarr %}
    ((total_checks++))
    if check_service "Lidarr" "http://localhost:{{ media_lidarr_port }}/api/v1/system/status?apikey={{ media_lidarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_lidarr_container_name }}" "Lidarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_readarr %}
    ((total_checks++))
    if check_service "Readarr" "http://localhost:{{ media_readarr_port }}/api/v1/system/status?apikey={{ media_readarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_readarr_container_name }}" "Readarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_prowlarr %}
    ((total_checks++))
    if check_service "Prowlarr" "http://localhost:{{ media_prowlarr_port }}/api/v1/system/status?apikey={{ media_prowlarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_prowlarr_container_name }}" "Prowlarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_bazarr %}
    ((total_checks++))
    if check_service "Bazarr" "http://localhost:{{ media_bazarr_port }}/api/system/status?apikey={{ media_bazarr_api_key | default('') }}"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_bazarr_container_name }}" "Bazarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_pulsarr %}
    ((total_checks++))
    if check_service "Pulsarr" "http://localhost:{{ media_pulsarr_port }}/health"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_pulsarr_container_name }}" "Pulsarr"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_overseerr %}
    ((total_checks++))
    if check_service "Overseerr" "http://localhost:{{ media_overseerr_port }}/api/v1/status"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_overseerr_container_name }}" "Overseerr"; then
        ((failed_checks++))
    fi
{% endif %}
{% endif %}
{% if media_enable_players %}
    # Check media players
{% if media_enable_plex %}
    ((total_checks++))
    if check_service "Plex" "http://localhost:{{ media_plex_port }}/web/index.html"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_plex_container_name }}" "Plex"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_jellyfin %}
    ((total_checks++))
    if check_service "Jellyfin" "http://localhost:{{ media_jellyfin_port }}/health"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_jellyfin_container_name }}" "Jellyfin"; then
        ((failed_checks++))
    fi
{% endif %}
{% if media_enable_emby %}
    ((total_checks++))
    if check_service "Emby" "http://localhost:{{ media_emby_port }}/health"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_emby_container_name }}" "Emby"; then
        ((failed_checks++))
    fi
{% endif %}
{% endif %}
{% if media_enable_monitoring %}
    # Check monitoring services
{% if media_enable_tautulli %}
    ((total_checks++))
    if check_service "Tautulli" "http://localhost:{{ media_tautulli_port }}/api/v2?apikey={{ media_tautulli_api_key | default('') }}&cmd=status"; then
        ((failed_checks++))
    fi
    
    ((total_checks++))
    if ! check_container "{{ media_tautulli_container_name }}" "Tautulli"; then
        ((failed_checks++))
    fi
{% endif %}
{% endif %}
    
    # Check storage space
    ((total_checks++))
    local storage_usage=$(df "{{ media_base_dir }}" | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ "$storage_usage" -gt 90 ]; then
        log "${RED}✗ Storage usage is high: ${storage_usage}%${NC}"
        ((failed_checks++))
    else
        log "${GREEN}✓ Storage usage is acceptable: ${storage_usage}%${NC}"
    fi
    
    # Check memory usage
    ((total_checks++))
    local memory_usage=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    if [ "$memory_usage" -gt 90 ]; then
        log "${RED}✗ Memory usage is high: ${memory_usage}%${NC}"
        ((failed_checks++))
    else
        log "${GREEN}✓ Memory usage is acceptable: ${memory_usage}%${NC}"
    fi
    
    # Summary
    local passed_checks=$((total_checks - failed_checks))
    log "Health check completed: $passed_checks/$total_checks checks passed"
    
    if [ $failed_checks -eq 0 ]; then
        log "${GREEN}All media stack services are healthy!${NC}"
        exit 0
    else
        log "${RED}$failed_checks service(s) are unhealthy${NC}"
        exit 1
    fi
}

# Run main function
main "$@" 