# Media Stack Monitoring Configuration
# Generated by Ansible - Do not edit manually

# Prometheus scrape configuration for media services
scrape_configs:
{% if media_enable_downloaders %}
  # Downloaders
{% if media_enable_sabnzbd %}
  - job_name: 'sabnzbd'
    static_configs:
      - targets: ['{{ ansible_default_ipv4.address }}:{{ media_sabnzbd_port }}']
    metrics_path: '/api?mode=diskspace&apikey={{ media_sabnzbd_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_qbittorrent %}
  - job_name: 'qbittorrent'
    static_configs:
      - targets: ['{{ ansible_default_ipv4.address }}:{{ media_qbittorrent_port }}']
    metrics_path: '/api/v2/sync/maindata'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% endif %}
{% if media_enable_arr_services %}
  # ARR Services
{% if media_enable_sonarr %}
  - job_name: 'sonarr'
    static_configs:
      - targets: ['localhost:{{ media_sonarr_port }}']
    metrics_path: '/api/v3/system/status?apikey={{ media_sonarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_radarr %}
  - job_name: 'radarr'
    static_configs:
      - targets: ['localhost:{{ media_radarr_port }}']
    metrics_path: '/api/v3/system/status?apikey={{ media_radarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_lidarr %}
  - job_name: 'lidarr'
    static_configs:
      - targets: ['localhost:{{ media_lidarr_port }}']
    metrics_path: '/api/v1/system/status?apikey={{ media_lidarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_readarr %}
  - job_name: 'readarr'
    static_configs:
      - targets: ['localhost:{{ media_readarr_port }}']
    metrics_path: '/api/v1/system/status?apikey={{ media_readarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_prowlarr %}
  - job_name: 'prowlarr'
    static_configs:
      - targets: ['localhost:{{ media_prowlarr_port }}']
    metrics_path: '/api/v1/system/status?apikey={{ media_prowlarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_bazarr %}
  - job_name: 'bazarr'
    static_configs:
      - targets: ['localhost:{{ media_bazarr_port }}']
    metrics_path: '/api/system/status?apikey={{ media_bazarr_api_key | default('') }}'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_pulsarr %}
  - job_name: 'pulsarr'
    static_configs:
      - targets: ['localhost:{{ media_pulsarr_port }}']
    metrics_path: '/health'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_overseerr %}
  - job_name: 'overseerr'
    static_configs:
      - targets: ['localhost:{{ media_overseerr_port }}']
    metrics_path: '/api/v1/status'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% endif %}
{% if media_enable_players %}
  # Media Players
{% if media_enable_plex %}
  - job_name: 'plex'
    static_configs:
      - targets: ['localhost:{{ media_plex_port }}']
    metrics_path: '/web/index.html'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_jellyfin %}
  - job_name: 'jellyfin'
    static_configs:
      - targets: ['localhost:{{ media_jellyfin_port }}']
    metrics_path: '/health'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% if media_enable_emby %}
  - job_name: 'emby'
    static_configs:
      - targets: ['localhost:{{ media_emby_port }}']
    metrics_path: '/health'
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    scheme: http
{% endif %}
{% endif %}
{% if media_enable_monitoring %}
  # Monitoring Services
{% if media_enable_tautulli %}
  - job_name: 'tautulli'
    static_configs:
      - targets: ['localhost:{{ media_tautulli_port }}']
    metrics_path: '/api/v2?apikey={{ media_tautulli_api_key: "{{ vault_media_api_token | default("") }}"sabnzbd"} == 0
        for: 1m
        labels:
          severity: critical
          service: sabnzbd
        annotations:
          summary: "SABnzbd is down"
          description: "SABnzbd has been down for more than 1 minute"
{% endif %}
{% if media_enable_qbittorrent %}
      - alert: QBittorrentDown
        expr: up{job="qbittorrent"} == 0
        for: 1m
        labels:
          severity: critical
          service: qbittorrent
        annotations:
          summary: "qBittorrent is down"
          description: "qBittorrent has been down for more than 1 minute"
{% endif %}
{% endif %}
{% if media_enable_arr_services %}
{% if media_enable_sonarr %}
      - alert: SonarrDown
        expr: up{job="sonarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: sonarr
        annotations:
          summary: "Sonarr is down"
          description: "Sonarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_radarr %}
      - alert: RadarrDown
        expr: up{job="radarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: radarr
        annotations:
          summary: "Radarr is down"
          description: "Radarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_lidarr %}
      - alert: LidarrDown
        expr: up{job="lidarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: lidarr
        annotations:
          summary: "Lidarr is down"
          description: "Lidarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_readarr %}
      - alert: ReadarrDown
        expr: up{job="readarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: readarr
        annotations:
          summary: "Readarr is down"
          description: "Readarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_prowlarr %}
      - alert: ProwlarrDown
        expr: up{job="prowlarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: prowlarr
        annotations:
          summary: "Prowlarr is down"
          description: "Prowlarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_bazarr %}
      - alert: BazarrDown
        expr: up{job="bazarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: bazarr
        annotations:
          summary: "Bazarr is down"
          description: "Bazarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_pulsarr %}
      - alert: PulsarrDown
        expr: up{job="pulsarr"} == 0
        for: 1m
        labels:
          severity: critical
          service: pulsarr
        annotations:
          summary: "Pulsarr is down"
          description: "Pulsarr has been down for more than 1 minute"
{% endif %}
{% if media_enable_overseerr %}
      - alert: OverseerrDown
        expr: up{job="overseerr"} == 0
        for: 1m
        labels:
          severity: critical
          service: overseerr
        annotations:
          summary: "Overseerr is down"
          description: "Overseerr has been down for more than 1 minute"
{% endif %}
{% endif %}
{% if media_enable_players %}
{% if media_enable_plex %}
      - alert: PlexDown
        expr: up{job="plex"} == 0
        for: 1m
        labels:
          severity: critical
          service: plex
        annotations:
          summary: "Plex is down"
          description: "Plex has been down for more than 1 minute"
{% endif %}
{% if media_enable_jellyfin %}
      - alert: JellyfinDown
        expr: up{job="jellyfin"} == 0
        for: 1m
        labels:
          severity: critical
          service: jellyfin
        annotations:
          summary: "Jellyfin is down"
          description: "Jellyfin has been down for more than 1 minute"
{% endif %}
{% if media_enable_emby %}
      - alert: EmbyDown
        expr: up{job="emby"} == 0
        for: 1m
        labels:
          severity: critical
          service: emby
        annotations:
          summary: "Emby is down"
          description: "Emby has been down for more than 1 minute"
{% endif %}
{% endif %}
{% if media_enable_monitoring %}
{% if media_enable_tautulli %}
      - alert: TautulliDown
        expr: up{job="tautulli"} == 0
        for: 1m
        labels:
          severity: critical
          service: tautulli
        annotations:
          summary: "Tautulli is down"
          description: "Tautulli has been down for more than 1 minute"
{% endif %}
{% endif %}
      
      # System resource alerts
      - alert: MediaStorageHigh
        expr: (node_filesystem_avail_bytes{mountpoint="{{ media_base_dir }}"} / node_filesystem_size_bytes{mountpoint="{{ media_base_dir }}"} * 100) < 10
        for: 5m
        labels:
          severity: warning
          service: media_stack
        annotations:
          summary: "Media storage is running low"
          description: "Media storage usage is above 90%"
      
      - alert: MediaMemoryHigh
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: media_stack
        annotations:
          summary: "Media server memory usage is high"
          description: "Memory usage is above 90%"
      
      - alert: MediaCPUHigh
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: media_stack
        annotations:
          summary: "Media server CPU usage is high"
          description: "CPU usage is above 80%" 