---
# Vaultwarden Monitoring Configuration
# Configures monitoring integration for Vaultwarden

- name: Configure Vaultwarden Prometheus monitoring
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/vaultwarden.yml"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"
  when: vaultwarden_prometheus_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, prometheus]

- name: Configure Vaultwarden Grafana dashboard
  ansible.builtin.template:
    src: grafana-dashboard.json.j2
    dest: "{{ grafana_dashboards_dir }}/vaultwarden.json"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"
  when: vaultwarden_grafana_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, grafana]

- name: Configure Vaultwarden Loki logging
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ loki_config_dir }}/vaultwarden.yml"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"
  when: vaultwarden_loki_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, loki]

- name: Configure Vaultwarden Telegraf monitoring
  ansible.builtin.template:
    src: telegraf.conf.j2
    dest: "{{ telegraf_config_dir }}/vaultwarden.conf"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"
  when: vaultwarden_telegraf_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, telegraf]

- name: Restart monitoring services for Vaultwarden
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - prometheus
    - grafana
    - loki
    - telegraf
  when: vaultwarden_monitoring_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, restart]

- name: Verify Vaultwarden monitoring endpoints
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code: [200, 302, 401]
    timeout: 10
  loop:
    - "http://localhost:{{ prometheus_port }}/api/v1/targets"
    - "http://localhost:{{ grafana_port }}/api/health"
  when: vaultwarden_monitoring_enabled | default(true)
  tags: [vaultwarden, vaultwarden-monitoring, verify]

- name: Display Vaultwarden monitoring status
  ansible.builtin.debug:
    msg: |
      ========================================
      VAULTWARDEN MONITORING STATUS
      ========================================
      
      Monitoring Integration:
      - Prometheus: {{ 'ENABLED' if vaultwarden_prometheus_enabled else 'DISABLED' }}
      - Grafana: {{ 'ENABLED' if vaultwarden_grafana_enabled else 'DISABLED' }}
      - Loki: {{ 'ENABLED' if vaultwarden_loki_enabled else 'DISABLED' }}
      - Telegraf: {{ 'ENABLED' if vaultwarden_telegraf_enabled else 'DISABLED' }}
      
      Health Check:
      - URL: http://localhost:{{ vaultwarden_port }}/alive
      - Interval: {{ vaultwarden_health_check_interval }}s
      - Timeout: {{ vaultwarden_health_check_timeout }}s
      
      Metrics:
      - Scrape Interval: {{ vaultwarden_prometheus_scrape_interval }}s
      - Metrics Enabled: {{ vaultwarden_metrics_enabled }}
      
      ========================================
  tags: [vaultwarden, vaultwarden-monitoring, summary] 