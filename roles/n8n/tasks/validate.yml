---
# n8n Configuration Validation
# Validate all required variables and prerequisites

- name: Validate n8n configuration variables
  ansible.builtin.assert:
    that:
      - n8n_enabled is defined
      - n8n_subdomain is defined
      - n8n_port is defined
      - n8n_database_host is defined
      - n8n_database_name is defined
      - n8n_database_user is defined
    fail_msg: "Required n8n configuration variables are not defined"
    success_msg: "n8n configuration validation passed"
  tags: [n8n, validation]

- name: Validate n8n vault variables
  ansible.builtin.assert:
    that:
      - vault_n8n_postgres_password is defined
      - vault_n8n_admin_password is defined
      - vault_n8n_encryption_key is defined
    fail_msg: "Required n8n vault variables are not defined"
    success_msg: "n8n vault variables validation passed"
  tags: [n8n, validation]

- name: Validate n8n port availability
  ansible.builtin.wait_for:
    port: "{{ n8n_port }}"
    state: stopped
    timeout: 5
  ignore_errors: true
  register: n8n_port_check
  tags: [n8n, validation]

- name: Fail if n8n port is already in use
  ansible.builtin.fail:
    msg: "Port {{ n8n_port }} is already in use by another service"
  when: n8n_port_check.state == "started"
  tags: [n8n, validation]

- name: Validate n8n subdomain format
  ansible.builtin.assert:
    that:
      - n8n_subdomain | regex_search('^[a-zA-Z0-9-]+$')
    fail_msg: "n8n subdomain must contain only letters, numbers, and hyphens"
    success_msg: "n8n subdomain format validation passed"
  tags: [n8n, validation]

- name: Validate n8n resource limits
  ansible.builtin.assert:
    that:
      - n8n_memory_limit is defined
      - n8n_cpu_limit is defined
      - n8n_memory_limit | regex_search('^[0-9]+[gGmM]$')
      - n8n_cpu_limit | regex_search('^[0-9]+\.?[0-9]*$')
    fail_msg: "n8n resource limits are not properly defined"
    success_msg: "n8n resource limits validation passed"
  tags: [n8n, validation] 