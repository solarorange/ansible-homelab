---
# n8n Monitoring Configuration
# Configure monitoring, metrics, and health checks for n8n

- name: Create n8n Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/n8n/prometheus.yml"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  when: n8n_prometheus_enabled | default(true)
  tags: [n8n, monitoring]

- name: Create n8n Grafana dashboard
  ansible.builtin.template:
    src: grafana-dashboard.json.j2
    dest: "{{ grafana_config_dir }}/n8n/dashboard.json"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  when: n8n_grafana_enabled | default(true)
  tags: [n8n, monitoring]

- name: Create n8n Loki configuration
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ loki_config_dir }}/n8n/loki-config.yml"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  when: n8n_loki_enabled | default(true)
  tags: [n8n, monitoring]

- name: Create n8n Telegraf configuration
  ansible.builtin.template:
    src: telegraf.conf.j2
    dest: "{{ telegraf_config_dir }}/n8n/telegraf.conf"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  when: n8n_telegraf_enabled | default(true)
  tags: [n8n, monitoring]

- name: Create n8n health check script
  ansible.builtin.template:
    src: healthcheck.sh.j2
    dest: "{{ n8n_config_dir }}/healthcheck.sh"
    mode: '0755'
    owner: "{{ username }}"
    group: "{{ username }}"
  when: n8n_health_check_enabled | default(true)
  tags: [n8n, monitoring]

- name: Setup n8n health check cron job
  ansible.builtin.cron:
    name: "n8n health check"
    minute: "*/{{ n8n_health_check_interval | default(30) }}"
    job: "{{ n8n_config_dir }}/healthcheck.sh >> {{ n8n_health_check_log_file }} 2>&1"
    user: "{{ username }}"
  when: n8n_health_check_enabled | default(true)
  tags: [n8n, monitoring]

- name: Create n8n log rotation configuration
  ansible.builtin.template:
    src: logrotate.conf.j2
    dest: "/etc/logrotate.d/n8n"
    mode: '0644'
    owner: root
    group: root
  when: n8n_log_rotation | default(true)
  tags: [n8n, monitoring]

- name: Restart monitoring services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: restarted
    enabled: yes
  loop:
    - prometheus
    - grafana
    - loki
    - telegraf
  ignore_errors: true
  when: n8n_monitoring_enabled | default(true)
  tags: [n8n, monitoring]

- name: Verify n8n monitoring endpoints
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code: [200, 401, 403]
    timeout: 10
  loop:
    - "http://localhost:{{ n8n_port }}/healthz"
    - "http://localhost:{{ n8n_port }}/metrics"
  register: n8n_monitoring_endpoints
  tags: [n8n, monitoring]

- name: Display n8n monitoring status
  ansible.builtin.debug:
    msg: |
      n8n Monitoring Status:
      - Prometheus: {{ n8n_prometheus_enabled | default(true) }}
      - Grafana: {{ n8n_grafana_enabled | default(true) }}
      - Loki: {{ n8n_loki_enabled | default(true) }}
      - Telegraf: {{ n8n_telegraf_enabled | default(true) }}
      - Health Check: {{ n8n_health_check_enabled | default(true) }}
  tags: [n8n, monitoring] 