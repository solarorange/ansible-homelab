---
- name: Harden permissions on storage directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "{{ item.mode | default('0750') }}"
    recurse: true
  loop:
    - { path: "{{ data_dir }}", mode: "0750" }
    - { path: "{{ backup_dir }}", mode: "0700" }
    - { path: "{{ config_dir }}", mode: "0750" }
    - { path: "{{ logs_dir }}", mode: "0750" }

- name: Ensure Samba config is secure
  ansible.builtin.lineinfile:
    path: "{{ docker_data_root }}/samba/config/smb.conf"
    regexp: '^\s*guest ok ='
    line: '   guest ok = no'
    state: present

- name: Enable UFW firewall and allow required ports
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 445
    - 139
    - 8384
    - 22000
    - 80
    - 443
  when: not (firewall.centralized | default(false))

- name: Enable UFW firewall and allow required UDP ports
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: udp
  loop:
    - 137
    - 138
    - 21027
  when: not (firewall.centralized | default(false))

- name: Enable UFW firewall
  community.general.ufw:
    state: enabled
    policy: deny
  when: not (firewall.centralized | default(false))

- name: Ensure encryption is enabled for backup
  ansible.builtin.command: "echo 'Encryption enabled for backup'"
  when: encryption_enabled
