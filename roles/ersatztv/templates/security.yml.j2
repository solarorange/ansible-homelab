# ErsatzTV Security Configuration
# Generated by Ansible - Do not edit manually

# Firewall Configuration
firewall:
  enabled: {{ ersatztv_firewall_enabled | lower }}
  rules:
    - port: "{{ ersatztv_port }}"
      protocol: "tcp"
      source: "{{ ersatztv_firewall_allowed_sources | default('any') }}"
      action: "allow"
    - port: "{{ ersatztv_prometheus_port | default(9090) }}"
      protocol: "tcp"
      source: "{{ ersatztv_monitoring_network | default('127.0.0.1') }}"
      action: "allow"

# Fail2ban Configuration
fail2ban:
  enabled: {{ ersatztv_fail2ban_enabled | lower }}
  jail:
    name: "ersatztv"
    port: "http,https"
    filter: "ersatztv"
    logpath: "{{ ersatztv_logs_dir }}/access.log"
    maxretry: "{{ ersatztv_fail2ban_maxretry | default(5) }}"
    bantime: "{{ ersatztv_fail2ban_bantime | default(3600) }}"
    findtime: "{{ ersatztv_fail2ban_findtime | default(600) }}"
  filter:
    name: "ersatztv"
    failregex:
      - '^<HOST>.*"GET.*HTTP/[0-9.]+" 401'
      - '^<HOST>.*"POST.*HTTP/[0-9.]+" 401'
      - '^<HOST>.*"GET.*HTTP/[0-9.]+" 403'
      - '^<HOST>.*"POST.*HTTP/[0-9.]+" 403'
    ignoreregex: ""

# CrowdSec Configuration
crowdsec:
  enabled: {{ ersatztv_crowdsec_enabled | lower }}
  acquisition:
    - source: "file"
      labels:
        type: "ersatztv"
      filenames:
        - "{{ ersatztv_logs_dir }}/access.log"
        - "{{ ersatztv_logs_dir }}/error.log"
  scenarios:
    - "http-probing"
    - "http-bad-user-agent"
    - "http-scan-non-standard-ports"

# Access Control
access_control:
  enabled: {{ ersatztv_access_control_enabled | lower }}
  authentication:
    type: "{{ ersatztv_auth_type | default('basic') }}"
    realm: "ErsatzTV"
    users:
      - username: "{{ ersatztv_admin_username | default('admin') }}"
        password: "{{ ersatztv_admin_password | default('changeme') }}"
  authorization:
    roles:
      - name: "admin"
        permissions: ["read", "write", "delete", "admin"]
      - name: "user"
        permissions: ["read", "write"]
      - name: "viewer"
        permissions: ["read"]

# Rate Limiting
rate_limiting:
  enabled: {{ ersatztv_rate_limiting_enabled | lower }}
  limits:
    - path: "/api/*"
      requests_per_minute: "{{ ersatztv_api_rate_limit | default(60) }}"
    - path: "/stream/*"
      requests_per_minute: "{{ ersatztv_stream_rate_limit | default(10) }}"
    - path: "/*"
      requests_per_minute: "{{ ersatztv_general_rate_limit | default(100) }}"

# CORS Configuration
cors:
  enabled: {{ ersatztv_cors_enabled | lower }}
  allowed_origins:
    - "https://{{ ersatztv_domain }}"
    - "https://{{ domain }}"
    - "http://localhost:{{ ersatztv_port }}"
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
  allowed_headers:
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"
  allow_credentials: true
  max_age: 86400

# Security Headers
security_headers:
  enabled: {{ ersatztv_security_headers_enabled | lower }}
  headers:
    - name: "X-Content-Type-Options"
      value: "nosniff"
    - name: "X-Frame-Options"
      value: "DENY"
    - name: "X-XSS-Protection"
      value: "1; mode=block"
    - name: "Referrer-Policy"
      value: "strict-origin-when-cross-origin"
    - name: "Content-Security-Policy"
      value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';"

# SSL/TLS Configuration
ssl:
  enabled: {{ ersatztv_ssl_enabled | lower }}
  certificate:
    path: "{{ ersatztv_ssl_cert_path | default('/etc/ssl/certs/ersatztv.crt') }}"
    key_path: "{{ ersatztv_ssl_key_path | default('/etc/ssl/private/ersatztv.key') }}"
  protocols:
    - "TLSv1.2"
    - "TLSv1.3"
  ciphers: "ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384"
  hsts:
    enabled: true
    max_age: 31536000
    include_subdomains: true
    preload: true

# API Security
api_security:
  enabled: {{ ersatztv_api_security_enabled | lower }}
  authentication:
    type: "{{ ersatztv_api_auth_type | default('api_key') }}"
    api_key_header: "X-API-Key"
    api_key: "{{ ersatztv_api_key | default('changeme') }}"
  rate_limiting:
    enabled: true
    requests_per_minute: "{{ ersatztv_api_rate_limit | default(60) }}"
  input_validation:
    enabled: true
    max_request_size: "10MB"
    allowed_content_types:
      - "application/json"
      - "application/xml"
      - "text/plain"

# Network Security
network_security:
  enabled: {{ ersatztv_network_security_enabled | lower }}
  bind_address: "{{ ersatztv_bind_address | default('0.0.0.0') }}"
  allowed_networks:
    - "{{ ersatztv_allowed_networks | default('127.0.0.1/32') }}"
  proxy_headers:
    - "X-Forwarded-For"
    - "X-Forwarded-Proto"
    - "X-Forwarded-Host"
  trust_proxy: true

# Container Security
container_security:
  enabled: {{ ersatztv_container_security_enabled | lower }}
  read_only_root: true
  no_new_privileges: true
  capabilities:
    drop:
      - "ALL"
    add:
      - "NET_BIND_SERVICE"
  seccomp_profile: "unconfined"
  apparmor_profile: "unconfined"
  user: "{{ user_id | default(1000) }}:{{ group_id | default(1000) }}" 