# Test Service Role

This role deploys and manages Test Service for the homelab environment. It provides modular tasks for deployment, validation, monitoring, backup, security, and homepage integration.

## Features
- Deploy and configure Test Service
- Traefik integration with SSL/TLS
- Monitoring and alerting integration
- Automated backup and restore
- Security hardening and compliance
- Homepage integration
- Health checks and validation

## Directory Structure
- `defaults/`: Default variables
- `handlers/`: Service handlers
- `tasks/`: Modular tasks (main, deploy, monitoring, security, backup, homepage, alerts, validate, etc.)
- `templates/`: Jinja2 templates for configs, scripts, homepage, etc.

## Usage
Include this role in your playbook:
```yaml
- hosts: all
  roles:
    - role: testservice
```

## Variables
See `defaults/main.yml` for all configurable options. Sensitive variables should be stored in Ansible Vault.

## Integration
- Monitoring: Prometheus, Grafana, logrotate
- Backup: Scheduled, compressed, encrypted
- Security: Hardening, access control, fail2ban, firewall
- Homepage: Service registration and status

## Validation & Health Checks
- Automated validation and health scripts for Test Service

## Author
Generated by Ansible Homelab Service Integration Wizard

## Configuration
- **Port**: Default
- **Domain**: testservice.{{ domain }}
- **Category**: utilities
- **Stage**: stage3

## Dependencies
- None

## Environment Variables
- Default configuration

## Volumes
- Default volumes

## Rollback

- Automatic rollback on failed deploys: Safe deploy restores last-known-good Compose and pre-change snapshot automatically if a deployment fails.

- Manual rollback (this service):
  - Option A — restore last-known-good Compose
    ```bash
    SERVICE=<service>  # e.g., testservice
    sudo cp {{ backup_dir }}/${SERVICE}/last_good/docker-compose.yml {{ docker_dir }}/${SERVICE}/docker-compose.yml
    if [ -f {{ backup_dir }}/${SERVICE}/last_good/.env ]; then sudo cp {{ backup_dir }}/${SERVICE}/last_good/.env {{ docker_dir }}/${SERVICE}/.env; fi
    docker compose -f {{ docker_dir }}/${SERVICE}/docker-compose.yml up -d
    ```
  - Option B — restore pre-change snapshot
    ```bash
    SERVICE=<service>
    ls -1 {{ backup_dir }}/${SERVICE}/prechange_*.tar.gz
    sudo tar -xzf {{ backup_dir }}/${SERVICE}/prechange_<TIMESTAMP>.tar.gz -C /
    docker compose -f {{ docker_dir }}/${SERVICE}/docker-compose.yml up -d
    ```

- Rollback to a recorded rollback point (target host):
  ```bash
  ls -1 {{ docker_dir }}/rollback/rollback-point-*.json | sed -E 's/.*rollback-point-([0-9]+)\.json/\1/'
  sudo {{ docker_dir }}/rollback/rollback.sh <ROLLBACK_ID>
  ```

- Full stack version rollback:
  ```bash
  /Users/rob/Cursor/ansible_homelab/scripts/version_rollback.sh --list
  /Users/rob/Cursor/ansible_homelab/scripts/version_rollback.sh tag:vX.Y.Z
  /Users/rob/Cursor/ansible_homelab/scripts/version_rollback.sh backup:/Users/rob/Cursor/ansible_homelab/backups/versions/<backup_dir>
  ```
