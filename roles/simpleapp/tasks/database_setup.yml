---
# Simple App Database Setup

- name: Check Simple App database connection
  ansible.builtin.uri:
    url: "https://{{ simpleapp_domain }}/api/health/database"
    method: GET
  register: db_check
  ignore_errors: yes
  tags: [simpleapp, database]

- name: Initialize Simple App database
  uri:
    url: "https://{{ simpleapp_domain }}/api/admin/database/init"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_simpleapp_api_key | default('') }}"
    body_format: json
    body:
      database_type: "{{ simpleapp_database_type }}"
      host: "{{ simpleapp_database_host if simpleapp_database_type == 'postgresql' else '' }}"
      port: "{{ simpleapp_database_port if simpleapp_database_type == 'postgresql' else '' }}"
      name: "{{ simpleapp_database_name if simpleapp_database_type == 'postgresql' else '' }}"
      user: "{{ vault_service_user if simpleapp_database_type == 'postgresql' else '' }}"
      password: "{{ vault_service_password if simpleapp_database_type == 'postgresql' else '' }}"
  when: db_check.status is not defined or db_check.status != 200
  tags: [simpleapp, database]

- name: Pre-change snapshot (config and data)
  ansible.builtin.include_tasks: "{{ role_path }}/../automation/tasks/prechange_snapshot.yml"
  vars:
    service_name: simpleapp
  tags: [backup, prechange]

- name: Run Simple App database migrations
  uri:
    url: "https://{{ simpleapp_domain }}/api/admin/database/migrate"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_simpleapp_api_key | default('') }}"
  tags: [simpleapp, database]
