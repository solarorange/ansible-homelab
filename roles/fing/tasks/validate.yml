---
# Fing Configuration Validation
# Validates all required variables and dependencies

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - domain is defined
      - username is defined
      - docker_dir is defined
      - docker_compose_dir is defined
      - logs_dir is defined
      - config_dir is defined
    fail_msg: "Required variables are not defined. Check group_vars/all/vars.yml"
  tags: [fing, validation]

- name: Validate Fing configuration
  ansible.builtin.assert:
    that:
      - fing_enabled is defined
      - fing_domain is defined
      - fing_web_port is defined
      - fing_api_port is defined
      - fing_scan_interval is defined
      - fing_network_ranges is defined
    fail_msg: "Fing configuration variables are not properly defined"
  tags: [fing, validation]

- name: Validate network configuration
  ansible.builtin.assert:
    that:
      - fing_network_mode is defined
      - fing_network_ranges | length > 0
      - fing_scan_interval > 0
      - fing_scan_timeout > 0
    fail_msg: "Fing network configuration is invalid"
  tags: [fing, validation]

- name: Validate monitoring integration
  ansible.builtin.assert:
    that:
      - fing_monitoring_enabled is defined
      - fing_metrics_enabled is defined
      - fing_health_check_enabled is defined
    fail_msg: "Fing monitoring configuration is invalid"
  tags: [fing, validation]

- name: Validate security configuration
  ansible.builtin.assert:
    that:
      - fing_auth_enabled is defined
      - fing_auth_method is defined
      - fing_security_headers is defined
      - fing_rate_limiting is defined
    fail_msg: "Fing security configuration is invalid"
  tags: [fing, validation]

- name: Validate Traefik integration
  ansible.builtin.assert:
    that:
      - fing_traefik_enabled is defined
      - fing_traefik_network is defined
      - fing_traefik_middleware is defined
    fail_msg: "Fing Traefik configuration is invalid"
  tags: [fing, validation]

- name: Validate homepage integration
  ansible.builtin.assert:
    that:
      - fing_homepage_enabled is defined
      - fing_homepage_category is defined
      - fing_homepage_description is defined
      - fing_homepage_icon is defined
    fail_msg: "Fing Homepage configuration is invalid"
  tags: [fing, validation]

- name: Check required services
  ansible.builtin.assert:
    that:
      - "'traefik' in enabled_services"
      - "'docker' in enabled_services"
    fail_msg: "Required services (traefik, docker) are not enabled"
  tags: [fing, validation]

- name: Check monitoring services if enabled
  ansible.builtin.assert:
    that:
      - "'prometheus' in enabled_services"
      - "'grafana' in enabled_services"
      - "'telegraf' in enabled_services"
    fail_msg: "Required monitoring services are not enabled"
  when: fing_monitoring_enabled | default(true)
  tags: [fing, validation]

- name: Check security services if enabled
  ansible.builtin.assert:
    that:
      - "'crowdsec' in enabled_services"
      - "'fail2ban' in enabled_services"
    fail_msg: "Required security services are not enabled"
  when: fing_crowdsec_enabled | default(true) or fing_fail2ban_enabled | default(true)
  tags: [fing, validation]

- name: Validate port availability
  ansible.builtin.assert:
    that:
      - fing_web_port != 80
      - fing_web_port != 443
      - fing_web_port != 8080
      - fing_api_port != 80
      - fing_api_port != 443
      - fing_api_port != 8080
      - fing_metrics_port != 80
      - fing_metrics_port != 443
      - fing_metrics_port != 8080
    fail_msg: "Fing ports conflict with system ports"
  tags: [fing, validation]

- name: Validate resource limits
  ansible.builtin.assert:
    that:
      - fing_memory_limit is defined
      - fing_cpu_limit is defined
      - fing_storage_limit is defined
    fail_msg: "Fing resource limits are not defined"
  tags: [fing, validation]

- name: Display Fing configuration summary
  ansible.builtin.debug:
    msg: |
      Fing Configuration Summary:
      
      Service: {{ fing_container_name }}
      Domain: {{ fing_domain }}
      Web Port: {{ fing_web_port }}
      API Port: {{ fing_api_port }}
      Network Mode: {{ fing_network_mode }}
      Scan Interval: {{ fing_scan_interval }}s
      Network Ranges: {{ fing_network_ranges | join(', ') }}
      
      Monitoring: {{ fing_monitoring_enabled | default(true) }}
      Security: {{ fing_auth_enabled | default(true) }}
      Traefik: {{ fing_traefik_enabled | default(true) }}
      Homepage: {{ fing_homepage_enabled | default(true) }}
      Backup: {{ fing_backup_enabled | default(true) }}
      Alerts: {{ fing_alerting_enabled | default(true) }}
      
      Resource Limits:
      - Memory: {{ fing_memory_limit }}
      - CPU: {{ fing_cpu_limit }}
      - Storage: {{ fing_storage_limit }}
  tags: [fing, validation] 