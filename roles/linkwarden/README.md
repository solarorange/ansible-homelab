# Linkwarden Role

This Ansible role deploys and configures Linkwarden, a self-hosted bookmark management platform, in a production-ready homelab environment.

## Overview

Linkwarden is an open-source bookmark manager that allows you to save, organize, and share your bookmarks. It provides features like:

- Bookmark organization with collections and tags
- Link previews and metadata extraction
- User authentication and access control
- API for integration with other services
- Import/export functionality
- Search and filtering capabilities

## Features

### Core Functionality
- **Docker-based deployment** with PostgreSQL database
- **Traefik integration** for reverse proxy and SSL termination
- **Authentik integration** for authentication
- **Monitoring integration** with Prometheus, Grafana, and Loki
- **Backup automation** with retention policies
- **Health monitoring** with comprehensive checks
- **Security hardening** with CrowdSec and Fail2ban

### Integration Points
- **Homepage integration** for dashboard access
- **Alerting system** with AlertManager
- **Log aggregation** with Loki
- **Metrics collection** with Prometheus
- **Grafana dashboards** for monitoring

## Requirements

### System Requirements
- Docker and Docker Compose
- PostgreSQL 15+ (included in deployment)
- Minimum 2GB RAM
- Minimum 10GB storage
- Network access for container images

### Ansible Requirements
- Ansible 2.12+
- `community.docker` collection
- `ansible.builtin` modules

### Dependencies
- Traefik (for reverse proxy)
- Authentik (for authentication)
- Monitoring stack (optional)
- Backup system (optional)

## Role Variables

### Service Configuration
```yaml
linkwarden_enabled: true
linkwarden_version: "latest"
linkwarden_port: 3002
linkwarden_subdomain: "linkwarden"
```

### Database Configuration
```yaml
linkwarden_database_type: "postgresql"
linkwarden_database_host: "linkwarden-postgres"
linkwarden_database_name: "linkwarden"
linkwarden_database_user: "postgres"
linkwarden_database_password: "{{ vault_linkwarden_postgres_password }}"
```

### Authentication
```yaml
linkwarden_auth_method: "authentik"
linkwarden_admin_email: "{{ admin_email }}"
```

### Monitoring
```yaml
linkwarden_monitoring_enabled: true
linkwarden_prometheus_enabled: true
linkwarden_grafana_enabled: true
linkwarden_loki_enabled: true
```

### Backup
```yaml
linkwarden_backup_enabled: true
linkwarden_backup_schedule: "0 2 * * *"
linkwarden_backup_retention_days: 7
```

## Installation

### 1. Add to Inventory
Add `linkwarden` to the `enabled_services` list in your inventory:

```yaml
enabled_services:
  - traefik
  - authentik
  - linkwarden
  # ... other services
```

### 2. Configure Variables
**No manual configuration required!** All variables are automatically generated by the seamless setup wizard.

The following variables are automatically handled:
- `vault_linkwarden_postgres_password`: Secure database password (auto-generated)
- `vault_linkwarden_nextauth_secret`: Secure NextAuth secret (auto-generated)
- `linkwarden_subdomain`: Set to "bookmarks" by default
- `linkwarden_port`: Set to 3002 (conflict-free)
- All other required variables are automatically configured

If you need to customize settings, you can modify them in `group_vars/all/common.yml` after deployment.

### 3. Run Deployment
```bash
# Deploy Linkwarden only
ansible-playbook main.yml --tags linkwarden

# Deploy with all dependencies
ansible-playbook main.yml --tags infrastructure,linkwarden
```

## Usage

### Access
- **Web Interface**: https://linkwarden.yourdomain.com
- **Local Access**: http://localhost:3002

### Initial Setup
1. Access the web interface
2. Create your first user account
3. Configure authentication (if using Authentik)
4. Start adding bookmarks and collections

### Management Scripts
The role provides management scripts in `{{ linkwarden_config_dir }}/scripts/`:

```bash
# Start services
./manage.sh start

# Stop services
./manage.sh stop

# Restart services
./manage.sh restart

# Check status
./manage.sh status

# View logs
./manage.sh logs

# Update to latest version
./manage.sh update

# Create backup
./manage.sh backup

# Restore from backup
./manage.sh restore backup_file.sql
```

### Health Checks
```bash
# Run health check
./healthcheck.sh

# Check specific components
docker exec linkwarden-app curl -f http://localhost:3000/api/health
docker exec linkwarden-postgres pg_isready -U postgres
```

## Configuration

### Environment Variables
Key environment variables can be customized:

```yaml
linkwarden_components:
  app:
    environment:
      - NEXTAUTH_URL=https://linkwarden.yourdomain.com
      - NEXTAUTH_SECRET={{ vault_linkwarden_nextauth_secret }}
      - DATABASE_URL=postgresql://user:pass@host:port/db
      - DISABLE_REGISTRATION=false
      - DISABLE_ANONYMOUS_LINKS=false
```

### Custom Configuration
Add custom configuration files:

```yaml
linkwarden_custom_config:
  custom_setting: "value"
  another_setting: "value"
```

### Volume Mounts
Custom volume mounts can be added:

```yaml
linkwarden_volume_mounts:
  - "/path/to/external/data:/app/data"
  - "/path/to/external/config:/app/config"
```

## Monitoring

### Metrics
Linkwarden exposes metrics for:
- HTTP requests and responses
- Database connections
- Application performance
- Resource usage

### Dashboards
Grafana dashboards are automatically configured for:
- Service health monitoring
- Performance metrics
- Error tracking
- Resource utilization

### Alerts
AlertManager rules are configured for:
- Service downtime
- High resource usage
- Database connection issues
- Backup failures

## Backup and Recovery

### Automatic Backups
- Daily backups at 2 AM
- 7-day retention policy
- Compressed backup files
- Database and configuration backup

### Manual Backup
```bash
# Create backup
./backup.sh

# Backup files are stored in {{ linkwarden_backup_dir }}
```

### Recovery
```bash
# Restore from backup
./manage.sh restore backup_file.sql
```

## Security

### Authentication
- Authentik integration for SSO
- JWT token-based authentication
- Secure session management

### Network Security
- Traefik with SSL termination
- Security headers middleware
- Rate limiting protection

### Threat Protection
- CrowdSec integration for threat detection
- Fail2ban for brute force protection
- Regular security updates

## Troubleshooting

### Common Issues

#### Service Won't Start
```bash
# Check container logs
docker logs linkwarden-app
docker logs linkwarden-postgres

# Check health status
./healthcheck.sh
```

#### Database Connection Issues
```bash
# Test database connection
docker exec linkwarden-postgres pg_isready -U postgres

# Check database logs
docker logs linkwarden-postgres
```

#### Authentication Problems
1. Verify Authentik configuration
2. Check NEXTAUTH_SECRET is set
3. Verify NEXTAUTH_URL is correct

#### Backup Failures
```bash
# Check backup logs
tail -f {{ linkwarden_backup_log_file }}

# Test backup manually
./backup.sh
```

### Log Files
- Application logs: `{{ logs_dir }}/linkwarden/app/`
- Database logs: `{{ logs_dir }}/linkwarden/postgres/`
- Backup logs: `{{ logs_dir }}/linkwarden/backup/`
- Health check logs: `{{ logs_dir }}/linkwarden/health/`

### Debug Mode
Enable debug logging:

```yaml
linkwarden_debug_enabled: true
linkwarden_log_level: "debug"
```

## Maintenance

### Updates
```bash
# Update to latest version
./manage.sh update

# Check for updates
docker-compose pull
```

### Database Maintenance
```bash
# Optimize database
docker exec linkwarden-postgres vacuumdb -U postgres linkwarden

# Check database size
docker exec linkwarden-postgres psql -U postgres -c "SELECT pg_size_pretty(pg_database_size('linkwarden'));"
```

### Log Rotation
Logs are automatically rotated with:
- 30-day retention
- 10MB max file size
- Compression enabled

## API Integration

### REST API
Linkwarden provides a REST API for integration:

```bash
# Get bookmarks
curl -H "Authorization: Bearer YOUR_TOKEN" \
     https://linkwarden.yourdomain.com/api/bookmarks

# Create bookmark
curl -X POST -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"url":"https://example.com","title":"Example"}' \
     https://linkwarden.yourdomain.com/api/bookmarks
```

### Webhooks
Configure webhooks for events:
- Bookmark created/updated/deleted
- Collection changes
- User registration

## Contributing

### Development
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

### Testing
```bash
# Run tests
ansible-playbook tests/test_linkwarden.yml

# Validate configuration
ansible-playbook main.yml --tags linkwarden,validation
```

## License

This role is licensed under the MIT License. See LICENSE file for details.

## Support

### Documentation
- [Linkwarden Documentation](https://github.com/linkwarden/linkwarden)
- [Ansible Documentation](https://docs.ansible.com/)

### Issues
- Report bugs via GitHub Issues
- Include logs and configuration details
- Provide steps to reproduce

### Community
- Join the Linkwarden Discord
- Participate in discussions
- Share configurations and tips

## Changelog

### v1.0.0
- Initial release
- Basic deployment and configuration
- Monitoring integration
- Backup automation
- Security hardening 