# Traefik Configuration for Immich
# Generated by Ansible - DO NOT EDIT MANUALLY

http:
  routers:
    immich-server:
      rule: "Host(`{{ immich_subdomain }}.{{ domain }}`)"
      service: immich-server
      entryPoints:
        - websecure
      tls:
        certResolver: {{ immich_traefik_ssl_resolver | default('cloudflare') }}
      middlewares:
        - secure-headers
        - compress
        {% if immich_auth_enabled and immich_auth_method == 'authentik' %}
        - {{ immich_traefik_auth_middleware | default('authentik@docker') }}
        {% endif %}

    immich-web:
      rule: "Host(`{{ immich_subdomain }}.{{ domain }}`) && PathPrefix(`/`)"
      service: immich-web
      entryPoints:
        - websecure
      tls:
        certResolver: {{ immich_traefik_ssl_resolver | default('cloudflare') }}
      middlewares:
        - secure-headers
        - compress
        {% if immich_auth_enabled and immich_auth_method == 'authentik' %}
        - {{ immich_traefik_auth_middleware | default('authentik@docker') }}
        {% endif %}

  services:
    immich-server:
      loadBalancer:
        servers:
          - url: "http://immich-server:{{ immich_ports.server }}"
        healthCheck:
          path: "/api/health"
          interval: "30s"
          timeout: "10s"

    immich-web:
      loadBalancer:
        servers:
          - url: "http://immich-web:{{ immich_ports.web }}"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "10s"

  middlewares:
    secure-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        customRequestHeaders:
          X-Forwarded-Proto: "https"

    compress:
      compress: {} 