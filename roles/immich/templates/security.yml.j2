# Security configuration for Immich
# Generated by Ansible - DO NOT EDIT MANUALLY

# Network security
network_security:
  # Firewall rules
  firewall:
    allowed_ports:
      - 3001  # Immich Server API
      - 3000  # Immich Web
      - 5432  # PostgreSQL
      - 6379  # Redis
      - 3003  # Machine Learning
    
    allowed_sources:
      - "{{ homelab_subnet | default('192.168.1.0/24') }}"
      - "{{ ansible_host }}"
    
    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_size: 20

# Authentication and authorization
auth:
  # JWT configuration
  jwt:
    secret: "{{ immich_jwt_secret }}"
    expires_in: "{{ immich_jwt_expires_in | default('7d') }}"
    refresh_expires_in: "{{ immich_jwt_refresh_expires_in | default('30d') }}"
  
  # OAuth providers
  oauth:
    enabled: "{{ immich_oauth_enabled | default(false) }}"
    providers:
      google:
        enabled: "{{ immich_oauth_google_enabled | default(false) }}"
        client_id: "{{ immich_oauth_google_client_id | default('') }}"
        client_secret: "{{ immich_oauth_google_client_secret | default('') }}"
      github:
        enabled: "{{ immich_oauth_github_enabled | default(false) }}"
        client_id: "{{ immich_oauth_github_client_id | default('') }}"
        client_secret: "{{ immich_oauth_github_client_secret | default('') }}"
      oidc:
        enabled: "{{ immich_oauth_oidc_enabled | default(false) }}"
        issuer: "{{ immich_oauth_oidc_issuer | default('') }}"
        client_id: "{{ immich_oauth_oidc_client_id | default('') }}"
        client_secret: "{{ immich_oauth_oidc_client_secret | default('') }}"

# Data protection
data_protection:
  # Encryption
  encryption:
    enabled: true
    algorithm: "AES-256-GCM"
    key_rotation_days: 90
  
  # Backup encryption
  backup_encryption:
    enabled: true
    algorithm: "AES-256-GCM"
    key_file: "{{ config_dir }}/immich/backup.key"
  
  # Data retention
  retention:
    photos: "{{ immich_retention_photos | default('forever') }}"
    videos: "{{ immich_retention_videos | default('forever') }}"
    metadata: "{{ immich_retention_metadata | default('forever') }}"
    logs: "{{ immich_retention_logs | default('90d') }}"

# Access control
access_control:
  # IP whitelisting
  ip_whitelist:
    enabled: "{{ immich_ip_whitelist_enabled | default(false) }}"
    allowed_ips:
      - "{{ homelab_subnet | default('192.168.1.0/24') }}"
      - "{{ ansible_host }}"
  
  # User roles and permissions
  roles:
    admin:
      permissions:
        - "photos:read"
        - "photos:write"
        - "photos:delete"
        - "users:read"
        - "users:write"
        - "users:delete"
        - "system:read"
        - "system:write"
    user:
      permissions:
        - "photos:read"
        - "photos:write"
        - "photos:delete"
    guest:
      permissions:
        - "photos:read"

# Security headers
security_headers:
  # HTTP security headers
  headers:
    X-Frame-Options: "DENY"
    X-Content-Type-Options: "nosniff"
    X-XSS-Protection: "1; mode=block"
    Referrer-Policy: "strict-origin-when-cross-origin"
    Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' ws: wss:;"
    Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    Permissions-Policy: "camera=(), microphone=(), geolocation=()"

# Rate limiting
rate_limiting:
  # API rate limiting
  api:
    enabled: true
    window_ms: 900000  # 15 minutes
    max_requests: 100
    skip_successful_requests: false
    skip_failed_requests: false
  
  # Upload rate limiting
  upload:
    enabled: true
    max_file_size: "{{ immich_max_file_size | default('100MB') }}"
    max_files_per_request: 100
    allowed_mime_types:
      - "image/*"
      - "video/*"

# Monitoring and logging
security_monitoring:
  # Audit logging
  audit_log:
    enabled: true
    level: "info"
    file: "{{ logs_dir }}/immich/security/audit.log"
    max_size: "100MB"
    max_files: 10
  
  # Security events
  events:
    failed_login:
      enabled: true
      threshold: 5
      window_minutes: 15
      action: "block"
    
    suspicious_activity:
      enabled: true
      threshold: 10
      window_minutes: 60
      action: "alert"
  
  # Intrusion detection
  intrusion_detection:
    enabled: true
    rules:
      - name: "SQL Injection Attempt"
        pattern: "(UNION|SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER).*FROM"
        action: "block"
        severity: "high"
      
      - name: "XSS Attempt"
        pattern: "(<script|javascript:|onload=|onerror=)"
        action: "block"
        severity: "high"
      
      - name: "Path Traversal"
        pattern: "(\\.\\./|\\.\\.\\\\)"
        action: "block"
        severity: "medium"

# SSL/TLS configuration
ssl:
  # Certificate configuration
  certificate:
    enabled: true
    cert_file: "{{ ssl_cert_file | default('/etc/ssl/certs/immich.crt') }}"
    key_file: "{{ ssl_key_file | default('/etc/ssl/private/immich.key') }}"
    ca_file: "{{ ssl_ca_file | default('') }}"
  
  # TLS configuration
  tls:
    min_version: "TLSv1.2"
    max_version: "TLSv1.3"
    cipher_suites:
      - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
      - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
      - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
  
  # HSTS configuration
  hsts:
    enabled: true
    max_age: 31536000
    include_subdomains: true
    preload: false

# Container security
container_security:
  # Docker security options
  docker:
    no_new_privileges: true
    read_only_root_filesystem: false
    capabilities:
      drop:
        - "ALL"
      add:
        - "CHOWN"
        - "SETGID"
        - "SETUID"
  
  # Resource limits
  resources:
    memory_limit: "{{ immich_memory_limit | default('2G') }}"
    cpu_limit: "{{ immich_cpu_limit | default('2') }}"
    memory_reservation: "{{ immich_memory_reservation | default('1G') }}"
  
  # Network security
  network:
    mode: "bridge"
    isolation: true
    no_host_network: true 