# AlertManager configuration for Immich alerts
# Generated by Ansible - DO NOT EDIT MANUALLY

global:
  resolve_timeout: 5m
  slack_api_url: '{{ immich_slack_webhook_url | default("") }}'
  smtp_smarthost: '{{ immich_smtp_host | default("{{ ansible_default_ipv4.address }}:587") }}'
  smtp_from: '{{ immich_smtp_from | default("alertmanager@immich.local") }}'
  smtp_auth_username: '{{ immich_smtp_username | default("") }}'
  smtp_auth_password: '{{ immich_smtp_password | default("") }}'

route:
  group_by: ['alertname', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'immich-alerts'
  routes:
    - match:
        service: immich
        severity: critical
      receiver: 'immich-critical'
      repeat_interval: 1h
    - match:
        service: immich
        severity: warning
      receiver: 'immich-warning'
      repeat_interval: 2h
    - match:
        service: immich
      receiver: 'immich-alerts'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

receivers:
  - name: 'immich-alerts'
    email_configs:
      - to: '{{ immich_alert_email | default("admin@immich.local") }}'
        send_resolved: true
        headers:
          subject: 'Immich Alert: {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        html: |
          <h2>Immich Alert</h2>
          <p><strong>Alert:</strong> {{ "{{" }} .GroupLabels.alertname {{ "}}" }}</p>
          <p><strong>Service:</strong> {{ "{{" }} .GroupLabels.service {{ "}}" }}</p>
          <p><strong>Severity:</strong> {{ "{{" }} .CommonLabels.severity {{ "}}" }}</p>
          <p><strong>Summary:</strong> {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}</p>
          <p><strong>Description:</strong> {{ "{{" }} .CommonAnnotations.description {{ "}}" }}</p>
          <p><strong>Started:</strong> {{ "{{" }} .StartsAt {{ "}}" }}</p>
          {% if immich_slack_webhook_url | default("") != "" %}
    slack_configs:
      - api_url: '{{ immich_slack_webhook_url }}'
        channel: '{{ immich_slack_channel | default("#immich-alerts") }}'
        send_resolved: true
        title: 'Immich Alert: {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        text: |
          *Alert:* {{ "{{" }} .GroupLabels.alertname {{ "}}" }}
          *Service:* {{ "{{" }} .GroupLabels.service {{ "}}" }}
          *Severity:* {{ "{{" }} .CommonLabels.severity {{ "}}" }}
          *Summary:* {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}
          *Description:* {{ "{{" }} .CommonAnnotations.description {{ "}}" }}
          *Started:* {{ "{{" }} .StartsAt {{ "}}" }}
        {% endif %}
    {% if immich_discord_webhook_url | default("") != "" %}
    webhook_configs:
      - url: '{{ immich_discord_webhook_url }}'
        send_resolved: true
        http_config:
          headers:
            Content-Type: application/json
        body: |
          {
            "embeds": [{
              "title": "Immich Alert: {{ "{{" }} .GroupLabels.alertname {{ "}}" }}",
              "color": {{ "{{" }} if eq .CommonLabels.severity "critical" "16711680" "16776960" {{ "}}" }},
              "fields": [
                {
                  "name": "Service",
                  "value": "{{ "{{" }} .GroupLabels.service {{ "}}" }}",
                  "inline": true
                },
                {
                  "name": "Severity",
                  "value": "{{ "{{" }} .CommonLabels.severity {{ "}}" }}",
                  "inline": true
                },
                {
                  "name": "Summary",
                  "value": "{{ "{{" }} .CommonAnnotations.summary {{ "}}" }}"
                },
                {
                  "name": "Description",
                  "value": "{{ "{{" }} .CommonAnnotations.description {{ "}}" }}"
                }
              ],
              "timestamp": "{{ "{{" }} .StartsAt {{ "}}" }}"
            }]
          }
    {% endif %}

  - name: 'immich-critical'
    email_configs:
      - to: '{{ immich_critical_email | default(immich_alert_email | default("admin@immich.local")) }}'
        send_resolved: true
        headers:
          subject: 'üö® CRITICAL: Immich Alert - {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        html: |
          <h2 style="color: red;">üö® CRITICAL Immich Alert</h2>
          <p><strong>Alert:</strong> {{ "{{" }} .GroupLabels.alertname {{ "}}" }}</p>
          <p><strong>Service:</strong> {{ "{{" }} .GroupLabels.service {{ "}}" }}</p>
          <p><strong>Severity:</strong> {{ "{{" }} .CommonLabels.severity {{ "}}" }}</p>
          <p><strong>Summary:</strong> {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}</p>
          <p><strong>Description:</strong> {{ "{{" }} .CommonAnnotations.description {{ "}}" }}</p>
          <p><strong>Started:</strong> {{ "{{" }} .StartsAt {{ "}}" }}</p>
          <p><strong>Action Required:</strong> Immediate attention needed!</p>
    {% if immich_slack_webhook_url | default("") != "" %}
    slack_configs:
      - api_url: '{{ immich_slack_webhook_url }}'
        channel: '{{ immich_slack_critical_channel | default(immich_slack_channel | default("#immich-critical")) }}'
        send_resolved: true
        title: 'üö® CRITICAL: Immich Alert - {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        text: |
          üö® *CRITICAL ALERT*
          *Alert:* {{ "{{" }} .GroupLabels.alertname {{ "}}" }}
          *Service:* {{ "{{" }} .GroupLabels.service {{ "}}" }}
          *Severity:* {{ "{{" }} .CommonLabels.severity {{ "}}" }}
          *Summary:* {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}
          *Description:* {{ "{{" }} .CommonAnnotations.description {{ "}}" }}
          *Started:* {{ "{{" }} .StartsAt {{ "}}" }}
          *Action Required:* Immediate attention needed!
    {% endif %}

  - name: 'immich-warning'
    email_configs:
      - to: '{{ immich_warning_email | default(immich_alert_email | default("admin@immich.local")) }}'
        send_resolved: true
        headers:
          subject: '‚ö†Ô∏è WARNING: Immich Alert - {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        html: |
          <h2 style="color: orange;">‚ö†Ô∏è WARNING Immich Alert</h2>
          <p><strong>Alert:</strong> {{ "{{" }} .GroupLabels.alertname {{ "}}" }}</p>
          <p><strong>Service:</strong> {{ "{{" }} .GroupLabels.service {{ "}}" }}</p>
          <p><strong>Severity:</strong> {{ "{{" }} .CommonLabels.severity {{ "}}" }}</p>
          <p><strong>Summary:</strong> {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}</p>
          <p><strong>Description:</strong> {{ "{{" }} .CommonAnnotations.description {{ "}}" }}</p>
          <p><strong>Started:</strong> {{ "{{" }} .StartsAt {{ "}}" }}</p>
    {% if immich_slack_webhook_url | default("") != "" %}
    slack_configs:
      - api_url: '{{ immich_slack_webhook_url }}'
        channel: '{{ immich_slack_channel | default("#immich-alerts") }}'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: Immich Alert - {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
        text: |
          ‚ö†Ô∏è *WARNING*
          *Alert:* {{ "{{" }} .GroupLabels.alertname {{ "}}" }}
          *Service:* {{ "{{" }} .GroupLabels.service {{ "}}" }}
          *Severity:* {{ "{{" }} .CommonLabels.severity {{ "}}" }}
          *Summary:* {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}
          *Description:* {{ "{{" }} .CommonAnnotations.description {{ "}}" }}
          *Started:* {{ "{{" }} .StartsAt {{ "}}" }}
    {% endif %}

templates:
  - '/etc/alertmanager/template/*.tmpl' 