---
# Gluetun Database Setup

- name: Check Gluetun database connection
  ansible.builtin.uri:
    url: "https://{{ gluetun_domain }}/api/health/database"
    method: GET
  register: db_check
  ignore_errors: yes
  tags: [gluetun, database]

- name: Initialize Gluetun database
  uri:
    url: "https://{{ gluetun_domain }}/api/admin/database/init"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_gluetun_api_key | default('') }}"
    body_format: json
    body:
      database_type: "{{ gluetun_database_type }}"
      host: "{{ gluetun_database_host if gluetun_database_type == 'postgresql' else '' }}"
      port: "{{ gluetun_database_port if gluetun_database_type == 'postgresql' else '' }}"
      name: "{{ gluetun_database_name if gluetun_database_type == 'postgresql' else '' }}"
      user: "{{ vault_service_user if gluetun_database_type == 'postgresql' else '' }}"
      password: "{{ vault_service_password if gluetun_database_type == 'postgresql' else '' }}"
  when: db_check.status is not defined or db_check.status != 200
  tags: [gluetun, database]

- name: Pre-change snapshot (config and data)
  ansible.builtin.include_tasks: "{{ role_path }}/../automation/tasks/prechange_snapshot.yml"
  vars:
    service_name: gluetun
  tags: [backup, prechange]

- name: Run Gluetun database migrations
  uri:
    url: "https://{{ gluetun_domain }}/api/admin/database/migrate"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_gluetun_api_key | default('') }}"
  tags: [gluetun, database]
