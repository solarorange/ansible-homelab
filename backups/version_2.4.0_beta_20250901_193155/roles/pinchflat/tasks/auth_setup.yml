---
# Pinchflat Authentication Setup

- name: Check if Pinchflat admin user exists
  ansible.builtin.uri:
    url: "https://{{ pinchflat_domain }}/api/admin/users"
    method: GET
    headers:
      Authorization: "Bearer {{ vault_pinchflat_api_key | default('') }}"
  register: admin_check
  ignore_errors: yes
  tags: [pinchflat, auth]

- name: Create Pinchflat admin user
  ansible.builtin.uri:
    url: "https://{{ pinchflat_domain }}/api/admin/users"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_pinchflat_api_key | default('') }}"
    body_format: json
    body:
      email: "{{ pinchflat_admin_email }}"
      password: "{{ vault_service_password }}"
      role: "admin"
  when: admin_check.status is not defined or admin_check.status != 200
  tags: [pinchflat, auth]

- name: Configure Pinchflat authentication method
  uri:
    url: "https://{{ pinchflat_domain }}/api/admin/auth/config"
    method: PUT
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ vault_pinchflat_api_key | default('') }}"
    body_format: json
    body:
      method: "{{ pinchflat_auth_method }}"
      enabled: "{{ pinchflat_auth_enabled | lower }}"
  tags: [pinchflat, auth]
