version: '3.8'

networks:
  {{ pezzo_network_name }}:
    external: {{ pezzo_network_external | lower }}

services:
  # Pezzo Server
  {% if pezzo_components | default([]).server.enabled | default(true) %}
  pezzo-server:
    image: "{{ pezzo_components | default([]).server.image }}"
    container_name: "{{ pezzo_components | default([]).server.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).server.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.server.volumes %}
      - "{{ volume }}"
      {% endfor %}
      {% if pezzo_manage_secret_files | default(true) %}
      {% for key, value in pezzo_components | default([]).server.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - "{{ pezzo_config_dir }}/secrets/{{ key }}:/run/secrets/{{ key }}:ro"
      {% endif %}
      {% endfor %}
      {% endif %}
    labels:
      - "traefik.enable={{ 'true' if pezzo_traefik_enabled else 'false' }}"
      - "traefik.http.routers.pezzo-server.rule=Host(`api.{{ pezzo_subdomain }}.{{ domain }}`)"
      - "traefik.http.routers.pezzo-server.entrypoints=websecure"
      - "traefik.http.routers.pezzo-server.tls.certresolver={{ pezzo_traefik_ssl_resolver }}"
      - "traefik.http.services.pezzo-server.loadbalancer.server.port={{ pezzo_server_port }}"
      - "traefik.http.routers.pezzo-server.middlewares={{ pezzo_traefik_auth_middleware }}"
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port={{ pezzo_server_port }}"
      - "pezzo.prometheus.path=/metrics"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).server.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).server.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).server.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).server.healthcheck.retries }}
    depends_on:
      {% if pezzo_components is defined and pezzo_components
      for dependency in pezzo_components.server.depends_on %}
      - {{ dependency }}
      {% endfor %}
    mem_limit: {{ pezzo_components | default([]).server.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).server.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo Console
  {% if pezzo_components | default([]).console.enabled | default(true) %}
  pezzo-console:
    image: "{{ pezzo_components | default([]).console.image }}"
    container_name: "{{ pezzo_components | default([]).console.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).console.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.console.volumes %}
      - "{{ volume }}"
      {% endfor %}
    labels:
      - "traefik.enable={{ 'true' if pezzo_traefik_enabled else 'false' }}"
      - "traefik.http.routers.pezzo-console.rule=Host(`{{ pezzo_subdomain }}.{{ domain }}`)"
      - "traefik.http.routers.pezzo-console.entrypoints=websecure"
      - "traefik.http.routers.pezzo-console.tls.certresolver={{ pezzo_traefik_ssl_resolver }}"
      - "traefik.http.services.pezzo-console.loadbalancer.server.port={{ pezzo_console_port }}"
      - "traefik.http.routers.pezzo-console.middlewares={{ pezzo_traefik_auth_middleware }}"
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port={{ pezzo_console_port }}"
      - "pezzo.prometheus.path=/metrics"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).console.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).console.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).console.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).console.healthcheck.retries }}
    depends_on:
      {% if pezzo_components is defined and pezzo_components
      for dependency in pezzo_components.console.depends_on %}
      - {{ dependency }}
      {% endfor %}
    mem_limit: {{ pezzo_components | default([]).console.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).console.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo Proxy
  {% if pezzo_components | default([]).proxy.enabled | default(true) %}
  pezzo-proxy:
    image: "{{ pezzo_components | default([]).proxy.image }}"
    container_name: "{{ pezzo_components | default([]).proxy.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).proxy.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.proxy.volumes %}
      - "{{ volume }}"
      {% endfor %}
    labels:
      - "traefik.enable={{ 'true' if pezzo_traefik_enabled else 'false' }}"
      - "traefik.http.routers.pezzo-proxy.rule=Host(`proxy.{{ pezzo_subdomain }}.{{ domain }}`)"
      - "traefik.http.routers.pezzo-proxy.entrypoints=websecure"
      - "traefik.http.routers.pezzo-proxy.tls.certresolver={{ pezzo_traefik_ssl_resolver }}"
      - "traefik.http.services.pezzo-proxy.loadbalancer.server.port={{ pezzo_proxy_port }}"
      - "traefik.http.routers.pezzo-proxy.middlewares={{ pezzo_traefik_auth_middleware }}"
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port={{ pezzo_proxy_port }}"
      - "pezzo.prometheus.path=/metrics"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).proxy.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).proxy.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).proxy.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).proxy.healthcheck.retries }}
    depends_on:
      {% if pezzo_components is defined and pezzo_components
      for dependency in pezzo_components.proxy.depends_on %}
      - {{ dependency }}
      {% endfor %}
    mem_limit: {{ pezzo_components | default([]).proxy.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).proxy.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo PostgreSQL Database
  {% if pezzo_components | default([]).postgres.enabled | default(true) %}
  pezzo-postgres:
    image: "{{ pezzo_components | default([]).postgres.image }}"
    container_name: "{{ pezzo_components | default([]).postgres.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).postgres.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.postgres.volumes %}
      - "{{ volume }}"
      {% endfor %}
      {% if pezzo_manage_secret_files | default(true) %}
      {% for key, value in pezzo_components | default([]).postgres.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - "{{ pezzo_config_dir }}/secrets/{{ key }}:/run/secrets/{{ key }}:ro"
      {% endif %}
      {% endfor %}
      {% endif %}
    labels:
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port=5432"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).postgres.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).postgres.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).postgres.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).postgres.healthcheck.retries }}
    mem_limit: {{ pezzo_components | default([]).postgres.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).postgres.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo Redis
  {% if pezzo_components | default([]).redis.enabled | default(true) %}
  pezzo-redis:
    image: "{{ pezzo_components | default([]).redis.image }}"
    container_name: "{{ pezzo_components | default([]).redis.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).redis.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.redis.volumes %}
      - "{{ volume }}"
      {% endfor %}
      {% if pezzo_manage_secret_files | default(true) %}
      {% for key, value in pezzo_components | default([]).redis.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - "{{ pezzo_config_dir }}/secrets/{{ key }}:/run/secrets/{{ key }}:ro"
      {% endif %}
      {% endfor %}
      {% endif %}
    labels:
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port=6379"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).redis.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).redis.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).redis.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).redis.healthcheck.retries }}
    mem_limit: {{ pezzo_components | default([]).redis.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).redis.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo ClickHouse
  {% if pezzo_components | default([]).clickhouse.enabled | default(true) %}
  pezzo-clickhouse:
    image: "{{ pezzo_components | default([]).clickhouse.image }}"
    container_name: "{{ pezzo_components | default([]).clickhouse.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).clickhouse.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.clickhouse.volumes %}
      - "{{ volume }}"
      {% endfor %}
    labels:
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port=8123"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).clickhouse.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).clickhouse.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).clickhouse.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).clickhouse.healthcheck.retries }}
    mem_limit: {{ pezzo_components | default([]).clickhouse.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).clickhouse.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo SuperTokens
  {% if pezzo_components | default([]).supertokens.enabled | default(true) %}
  pezzo-supertokens:
    image: "{{ pezzo_components | default([]).supertokens.image }}"
    container_name: "{{ pezzo_components | default([]).supertokens.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).supertokens.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.supertokens.volumes %}
      - "{{ volume }}"
      {% endfor %}
    labels:
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port=3567"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).supertokens.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).supertokens.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).supertokens.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).supertokens.healthcheck.retries }}
    depends_on:
      {% if pezzo_components is defined and pezzo_components
      for dependency in pezzo_components.supertokens.depends_on %}
      - {{ dependency }}
      {% endfor %}
    mem_limit: {{ pezzo_components | default([]).supertokens.resources.limits.memory }}
    cpus: '{{ pezzo_components | default([]).supertokens.resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %}

  # Pezzo Local KMS
  {% if pezzo_components | default([]).local-kms.enabled | default(true) %}
  pezzo-local-kms:
    image: "{{ pezzo_components | default([]).local-kms.image }}"
    container_name: "{{ pezzo_components | default([]).local-kms.container_name }}"
    restart: "{{ pezzo_container_restart_policy }}"
    networks:
      - "{{ pezzo_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in pezzo_components | default([]).local-kms.environment.items() %}
      {% if key is match('(PASSWORD|TOKEN|SECRET|KEY)') %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if pezzo_components is defined and pezzo_components
      for volume in pezzo_components.local-kms.volumes %}
      - "{{ volume }}"
      {% endfor %}
    labels:
      # Prometheus scraping labels
      - "pezzo.prometheus.scrape=true"
      - "pezzo.prometheus.port=9981"
      # Loki scraping label
      - "pezzo.loki.scrape=true"
    healthcheck:
      test: {{ pezzo_components | default([]).local-kms.healthcheck.test }}
      interval: "{{ pezzo_components | default([]).local-kms.healthcheck.interval }}"
      timeout: "{{ pezzo_components | default([]).local-kms.healthcheck.timeout }}"
      retries: {{ pezzo_components | default([]).local-kms.healthcheck.retries }}
    mem_limit: {{ pezzo_components | default([])['local-kms'].resources.limits.memory }}
    cpus: '{{ pezzo_components | default([])['local-kms'].resources.limits.cpus }}'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
  {% endif %} 