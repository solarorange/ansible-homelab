#!/bin/bash
# Immich Health Check Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

# Configuration
IMMICH_DIR="{{ immich_config_dir }}"
LOG_FILE="{{ logs_dir }}/immich/health/health.log"
HEALTH_CHECK_URL="http://{{ ansible_default_ipv4.address }}:{{ immich_ports.server }}/api/health"
TIMEOUT="{{ immich_health_check_timeout | default(10) }}"
RETRIES="{{ immich_health_check_retries | default(3) }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Health check function
check_health() {
    local url="$1"
    local timeout="$2"
    local retries="$3"
    
    for i in $(seq 1 $retries); do
        if curl -f -s --max-time $timeout "$url" > /dev/null 2>&1; then
            return 0
        fi
        
        if [ $i -lt $retries ]; then
            log "Health check attempt $i failed, retrying in 5 seconds..."
            sleep 5
        fi
    done
    
    return 1
}

# Main health check
log "Starting Immich health check..."

# Check if containers are running
cd "$IMMICH_DIR"
if ! docker-compose ps | grep -q "Up"; then
    log "ERROR: Immich containers are not running"
    exit 1
fi

# Check API health endpoint
if check_health "$HEALTH_CHECK_URL" "$TIMEOUT" "$RETRIES"; then
    log "SUCCESS: Immich API health check passed"
else
    log "ERROR: Immich API health check failed"
    exit 1
fi

# Check database connectivity
if docker exec immich-postgres pg_isready -U postgres -d immich > /dev/null 2>&1; then
    log "SUCCESS: Database connectivity check passed"
else
    log "ERROR: Database connectivity check failed"
    exit 1
fi

# Check Redis connectivity
if docker exec immich-redis redis-cli -a {{ immich_redis_password }} ping | grep -q "PONG"; then
    log "SUCCESS: Redis connectivity check passed"
else
    log "ERROR: Redis connectivity check failed"
    exit 1
fi

log "SUCCESS: All Immich health checks passed" 