---
# Validates that secret-like environment keys use *_FILE indirection

- name: Validate secret-like env keys use *_FILE
  vars:
    env_map: "{{ env_map_input | default({}) }}"
    bad_items: >-
      {{
        (env_map | dict2items)
        | selectattr('key', 'match', '(PASSWORD|TOKEN|SECRET|KEY)')
        | rejectattr('key', 'search', '_FILE$')
        | list
      }}
  ansible.builtin.assert:
    that:
      - bad_items | length == 0
    fail_msg: >-
      Found secret-like env keys without *_FILE indirection: {{ bad_items | map(attribute='key') | list }}.
      Ensure you use KEY_FILE=/run/secrets/KEY and mount secret files accordingly.
    success_msg: "Secret-like env keys are using *_FILE indirection."

