---
# Utilities Stack Post-Deployment Validation

- name: Check Portainer service status
  ansible.builtin.shell: docker ps -f name=portainer --format '{{.Status}}'
  register: portainer_status
  changed_when: false

- name: Check Tdarr service status
  ansible.builtin.shell: docker ps -f name=tdarr --format '{{.Status}}'
  register: tdarr_status
  changed_when: false

- name: Check Tautulli service status
  ansible.builtin.shell: docker ps -f name=tautulli --format '{{.Status}}'
  register: tautulli_status
  changed_when: false

- name: Check Homepage service status
  ansible.builtin.shell: docker ps -f name=homepage --format '{{.Status}}'
  register: homepage_status
  changed_when: false

- name: Validate Portainer endpoint
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ portainer_port }}"
    method: GET
    status_code: 200
  register: portainer_endpoint
  retries: 5
  delay: 5
  until: portainer_endpoint.status == 200

- name: Validate Tdarr endpoint
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ tdarr_port }}"
    method: GET
    status_code: 200
  register: tdarr_endpoint
  retries: 5
  delay: 5
  until: tdarr_endpoint.status == 200

- name: Validate Tautulli endpoint
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ tautulli_port }}"
    method: GET
    status_code: 200
  register: tautulli_endpoint
  retries: 5
  delay: 5
  until: tautulli_endpoint.status == 200

- name: Validate Homepage endpoint
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:"
    method: GET
    status_code: 200
  register: homepage_endpoint
  retries: 5
  delay: 5
  until: homepage_endpoint.status == 200

- name: Display utilities stack deployment status
  ansible.builtin.debug:
    msg: |
      Utilities stack deployment completed successfully
      Portainer: {{ portainer_status.stdout }}
      Tdarr: {{ tdarr_status.stdout }}
      Tautulli: {{ tautulli_status.stdout }}
      Homepage: {{ homepage_status.stdout }}
  tags: [utilities, validation]
