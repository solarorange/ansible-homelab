version: '3.8'

networks:
  {{ linkwarden_network_name }}:
    external: {{ linkwarden_network_external | lower }}

services:
  # Linkwarden App
  {% if linkwarden_components | default([]).app.enabled | default(true) %}
  linkwarden-app:
    image: "{{ linkwarden_components | default([]).app.image }}"
    container_name: "{{ linkwarden_components | default([]).app.container_name }}"
    restart: "{{ linkwarden_container_restart_policy }}"
    networks:
      - "{{ linkwarden_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in linkwarden_components | default([]).app.environment.items() %}
      {% if linkwarden_manage_secret_files | default(true) and (key is match('(PASSWORD|TOKEN|SECRET|KEY)')) %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if linkwarden_components is defined and linkwarden_components
      for volume in linkwarden_components.app.volumes %}
      - "{{ volume }}"
      {% endfor %}
      {% if linkwarden_manage_secret_files | default(true) %}
      {% for secret in linkwarden_secret_files %}
      - "{{ docker_dir }}/linkwarden/secrets/{{ secret.name }}:/run/secrets/{{ secret.name }}:ro"
      {% endfor %}
      {% endif %}
      - "{{ logs_dir }}/linkwarden/app:/logs"
    {% if linkwarden_direct_expose_enabled | default(false) %}
    ports:
      - "{{ linkwarden_port }}:{{ linkwarden_port }}"
    {% endif %}
    labels:
      - "traefik.enable={{ 'true' if linkwarden_traefik_enabled else 'false' }}"
      - "traefik.http.routers.linkwarden.rule=Host(`{{ linkwarden_subdomain }}.{{ domain }}`)"
      - "traefik.http.routers.linkwarden.entrypoints=websecure"
      - "traefik.http.routers.linkwarden.tls.certresolver={{ linkwarden_traefik_ssl_resolver }}"
      - "traefik.http.services.linkwarden.loadbalancer.server.port={{ linkwarden_port }}"
      - "traefik.http.routers.linkwarden.middlewares={{ linkwarden_traefik_auth_middleware }}"
      # Prometheus scraping labels
      - "linkwarden.prometheus.scrape=true"
      - "linkwarden.prometheus.port={{ linkwarden_port }}"
      - "linkwarden.prometheus.path=/metrics"
      # Loki scraping label
      - "linkwarden.loki.scrape=true"
    healthcheck:
      test: {{ linkwarden_components | default([]).app.healthcheck.test }}
      interval: "{{ linkwarden_components | default([]).app.healthcheck.interval }}"
      timeout: "{{ linkwarden_components | default([]).app.healthcheck.timeout }}"
      retries: {{ linkwarden_components | default([]).app.healthcheck.retries }}
    depends_on:
      {% if linkwarden_components is defined and linkwarden_components
      for dependency in linkwarden_components.app.depends_on %}
      - {{ dependency }}
      {% endfor %}
    
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
    mem_limit: {{ linkwarden_components | default([]).app.resources.limits.memory }}
    cpus: '{{ linkwarden_components | default([]).app.resources.limits.cpus }}'
  {% endif %}

  # Linkwarden PostgreSQL Database
  {% if linkwarden_components | default([]).postgres.enabled | default(true) %}
  linkwarden-postgres:
    image: "{{ linkwarden_components | default([]).postgres.image }}"
    container_name: "{{ linkwarden_components | default([]).postgres.container_name }}"
    restart: "{{ linkwarden_container_restart_policy }}"
    networks:
      - "{{ linkwarden_network_name }}"
    environment:
      - PUID={{ PUID | default(1000) }}
      - PGID={{ PGID | default(1000) }}
      - TZ={{ timezone }}
      {% for key, value in linkwarden_components | default([]).postgres.environment.items() %}
      {% if linkwarden_manage_secret_files | default(true) and (key is match('(PASSWORD|TOKEN|SECRET|KEY)')) %}
      - {{ key }}_FILE=/run/secrets/{{ key }}
      {% else %}
      - {{ key }}={{ value }}
      {% endif %}
      {% endfor %}
    volumes:
      {% if linkwarden_components is defined and linkwarden_components
      for volume in linkwarden_components.postgres.volumes %}
      - "{{ volume }}"
      {% endfor %}
      {% if linkwarden_manage_secret_files | default(true) %}
      {% for secret in linkwarden_secret_files %}
      - "{{ docker_dir }}/linkwarden/secrets/{{ secret.name }}:/run/secrets/{{ secret.name }}:ro"
      {% endfor %}
      {% endif %}
      - "{{ logs_dir }}/linkwarden/postgres:/logs"
    labels:
      # Prometheus scraping labels
      - "linkwarden.prometheus.scrape=true"
      - "linkwarden.prometheus.port=5432"
      # Loki scraping label
      - "linkwarden.loki.scrape=true"
    healthcheck:
      test: {{ linkwarden_components | default([]).postgres.healthcheck.test }}
      interval: "{{ linkwarden_components | default([]).postgres.healthcheck.interval }}"
      timeout: "{{ linkwarden_components | default([]).postgres.healthcheck.timeout }}"
      retries: {{ linkwarden_components | default([]).postgres.healthcheck.retries }}
    
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp
    user: "{{ PUID | default(1000) }}:{{ PGID | default(1000) }}"
    mem_limit: {{ linkwarden_components | default([]).postgres.resources.limits.memory }}
    cpus: '{{ linkwarden_components | default([]).postgres.resources.limits.cpus }}'
  {% endif %} 