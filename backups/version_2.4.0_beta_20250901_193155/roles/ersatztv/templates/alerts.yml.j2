# ErsatzTV Alerts Configuration
# Generated by Ansible - Do not edit manually

# Alert Settings
alerts:
  enabled: {{ ersatztv_alerts_enabled | lower }}
  check_interval: "{{ ersatztv_alerts_check_interval | default('5m') }}"
  notification_cooldown: "{{ ersatztv_alerts_notification_cooldown | default('1h') }}"

# Alert Rules
rules:
  # Service Status Alerts
  - name: "ErsatzTV Service Down"
    condition: "ersatztv_up == 0"
    severity: "critical"
    duration: "1m"
    description: "ErsatzTV service is not responding"
    enabled: true

  - name: "ErsatzTV Container Stopped"
    condition: "container_status == 'exited'"
    severity: "critical"
    duration: "30s"
    description: "ErsatzTV container has stopped unexpectedly"
    enabled: true

  # Performance Alerts
  - name: "High CPU Usage"
    condition: "cpu_usage > 80"
    severity: "warning"
    duration: "5m"
    description: "ErsatzTV CPU usage is above 80%"
    enabled: true

  - name: "High Memory Usage"
    condition: "memory_usage > 85"
    severity: "warning"
    duration: "5m"
    description: "ErsatzTV memory usage is above 85%"
    enabled: true

  - name: "High Disk Usage"
    condition: "disk_usage > 90"
    severity: "warning"
    duration: "5m"
    description: "ErsatzTV disk usage is above 90%"
    enabled: true

  # Streaming Alerts
  - name: "No Active Streams"
    condition: "active_streams == 0"
    severity: "info"
    duration: "10m"
    description: "No active streams detected"
    enabled: true

  - name: "Stream Errors"
    condition: "stream_errors > 0"
    severity: "warning"
    duration: "2m"
    description: "Stream errors detected"
    enabled: true

  # Transcoding Alerts
  - name: "Transcoding Failures"
    condition: "transcoding_failures > 0"
    severity: "warning"
    duration: "2m"
    description: "Transcoding failures detected"
    enabled: true

  - name: "Low Transcoding Performance"
    condition: "transcoding_fps < 10"
    severity: "warning"
    duration: "5m"
    description: "Transcoding performance is below 10 FPS"
    enabled: true

  # API Alerts
  - name: "API Response Time High"
    condition: "api_response_time > 5"
    severity: "warning"
    duration: "5m"
    description: "API response time is above 5 seconds"
    enabled: true

  - name: "API Errors"
    condition: "api_errors > 0"
    severity: "warning"
    duration: "2m"
    description: "API errors detected"
    enabled: true

  # Database Alerts
  - name: "Database Connection Issues"
    condition: "database_connection_failures > 0"
    severity: "critical"
    duration: "1m"
    description: "Database connection failures detected"
    enabled: true

  - name: "Database Size Warning"
    condition: "database_size > 1073741824"
    severity: "warning"
    duration: "1h"
    description: "Database size is above 1GB"
    enabled: true

  # Network Alerts
  - name: "Network Connectivity Issues"
    condition: "network_connectivity_failures > 0"
    severity: "warning"
    duration: "2m"
    description: "Network connectivity issues detected"
    enabled: true

  - name: "High Network Usage"
    condition: "network_bandwidth > 1000000000"
    severity: "info"
    duration: "5m"
    description: "High network bandwidth usage detected"
    enabled: true

# Notification Channels
notifications:
  email:
    enabled: {{ ersatztv_email_alerts_enabled | lower }}
    smtp_server: "{{ ersatztv_smtp_server | default('{{ ansible_default_ipv4.address }}') }}"
    smtp_port: "{{ ersatztv_smtp_port | default(587) }}"
    smtp_username: "{{ ersatztv_smtp_username | default('') }}"
    smtp_password: "{{ ersatztv_smtp_password | default('') }}"
    from_address: "{{ ersatztv_email_from | default('ersatztv@{{ domain }}') }}"
    to_addresses: "{{ ersatztv_email_to | default([]) }}"
    subject_prefix: "{{ ersatztv_email_subject_prefix | default('[ErsatzTV Alert]') }}"

  slack:
    enabled: {{ ersatztv_slack_alerts_enabled | lower }}
    webhook_url: "{{ ersatztv_slack_webhook_url | default('') }}"
    channel: "{{ ersatztv_slack_channel | default('#alerts') }}"
    username: "{{ ersatztv_slack_username | default('ErsatzTV Bot') }}"
    icon_emoji: "{{ ersatztv_slack_icon | default(':tv:') }}"

  discord:
    enabled: {{ ersatztv_discord_alerts_enabled | lower }}
    webhook_url: "{{ ersatztv_discord_webhook_url | default('') }}"
    username: "{{ ersatztv_discord_username | default('ErsatzTV Bot') }}"
    avatar_url: "{{ ersatztv_discord_avatar | default('') }}"

  telegram:
    enabled: {{ ersatztv_telegram_alerts_enabled | lower }}
    bot_token: "{{ ersatztv_telegram_bot_token | default('') }}"
    chat_id: "{{ ersatztv_telegram_chat_id | default('') }}"

# Alert Templates
templates:
  email:
    subject: "{{ ersatztv_email_subject_template | default('[{{ severity | upper }}] {{ name }}') }}"
    body: |
      Alert: {{ name }}
      Severity: {{ severity }}
      Description: {{ description }}
      Time: {{ timestamp }}
      Duration: {{ duration }}
      
      Current Values:
      {% for metric, value in metrics.items() %}
      - {{ metric }}: {{ value }}
      {% endfor %}
      
      Service URL: https://{{ ersatztv_domain }}

  slack:
    text: |
      *{{ severity | upper }}: {{ name }}*
      {{ description }}
      Time: {{ timestamp }}
      Duration: {{ duration }}
      
      Current Values:
      {% for metric, value in metrics.items() %}
      â€¢ {{ metric }}: {{ value }}
      {% endfor %}
      
      <https://{{ ersatztv_domain }}|View Service>

  discord:
    embed:
      title: "{{ severity | upper }}: {{ name }}"
      description: "{{ description }}"
      color: "{{ 'ff0000' if severity == 'critical' else 'ffaa00' if severity == 'warning' else '00ff00' }}"
      fields:
        - name: "Time"
          value: "{{ timestamp }}"
          inline: true
        - name: "Duration"
          value: "{{ duration }}"
          inline: true
        {% for metric, value in metrics.items() %}
        - name: "{{ metric }}"
          value: "{{ value }}"
          inline: true
        {% endfor %}
      url: "https://{{ ersatztv_domain }}"

# Alert Suppression
suppression:
  enabled: {{ ersatztv_alert_suppression_enabled | lower }}
  rules:
    - name: "Maintenance Window"
      schedule: "{{ ersatztv_maintenance_schedule | default('0 2 * * 0') }}"
      duration: "2h"
      alerts:
        - "High CPU Usage"
        - "High Memory Usage"
        - "API Response Time High"

# Alert Escalation
escalation:
  enabled: {{ ersatztv_alert_escalation_enabled | lower }}
  levels:
    - level: 1
      delay: "5m"
      notifications: ["email"]
    - level: 2
      delay: "15m"
      notifications: ["email", "slack"]
    - level: 3
      delay: "1h"
      notifications: ["email", "slack", "discord"] 