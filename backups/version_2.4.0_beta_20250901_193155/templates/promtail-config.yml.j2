server:
  http_listen_port: {{ promtail_port | default(9080) }}
  grpc_listen_port: 0

positions:
  filename: {{ promtail_positions_file | default('/tmp/positions.yaml') }}

clients:
  - url: http://{{ loki_host | default('loki') }}:{{ loki_port | default(3100) }}/loki/api/v1/push

scrape_configs:
  # System logs
  - job_name: system_logs
    static_configs:
      - targets:
          - {{ ansible_default_ipv4.address }}
        labels:
          job: system_logs
          __path__: {{ system_log_path | default('/var/log/syslog') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:
          timestamp:

  # Docker logs
  - job_name: docker_logs
    static_configs:
      - targets:
          - {{ ansible_default_ipv4.address }}
        labels:
          job: docker_logs
          __path__: {{ docker_log_path | default('/var/lib/docker/containers/*/*-json.log') }}
    pipeline_stages:
      - json:
          expressions:
            stream: stream
            attrs: attrs
            tag: attrs.tag
            time: time
      - labels:
          stream:
          tag:

  # Journal logs
  - job_name: journal_logs
    journal:
      json: false
      max_age: {{ journal_max_age | default('12h') }}
      path: {{ journal_path | default('/var/log/journal') }}
      labels:
        job: journal_logs
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        target_label: 'unit'
      - source_labels: ['__journal__hostname']
        target_label: 'hostname'

  # Web services logs
  - job_name: web_services
    static_configs:
      - targets:
          - localhost
        labels:
          job: web_services
          __path__: {{ nginx_log_path | default('/var/log/nginx/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<ip>\S+) \S+ \S+ \[(?P<timestamp>[^\]]+)\] "(?P<method>\S+) (?P<path>\S+) \S+" (?P<status>\d+) (?P<size>\d+) "(?P<referer>[^"]*)" "(?P<useragent>[^"]*)"'
      - labels:
          method:
          status:
          path:

  # Security logs
  - job_name: security_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: security_logs
          __path__: {{ auth_log_path | default('/var/log/auth.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}) (?P<hostname>\S+) (?P<service>\S+): (?P<message>.*)$'
      - labels:
          service:

  # Database logs
  - job_name: database_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: database_logs
          __path__: {{ mysql_log_path | default('/var/log/mysql/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Monitoring logs
  - job_name: monitoring_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: monitoring_logs
          __path__: {{ prometheus_log_path | default('/var/log/prometheus/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Media logs
  - job_name: media_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: media_logs
          __path__: {{ sonarr_log_path | default('/var/log/sonarr/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Storage logs
  - job_name: storage_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: storage_logs
          __path__: {{ nextcloud_log_path | default('/var/log/nextcloud/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Automation logs
  - job_name: automation_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: automation_logs
          __path__: {{ homeassistant_log_path | default('/var/log/homeassistant/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Utility logs
  - job_name: utility_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: utility_logs
          __path__: {{ utilities_log_path | default('/var/log/utilities/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Application logs
  - job_name: application_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: application_logs
          __path__: {{ applications_log_path | default('/var/log/applications/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Ansible logs
  - job_name: ansible_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: ansible_logs
          __path__: {{ ansible_log_path | default('/var/log/ansible/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Backup logs
  - job_name: backup_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backup_logs
          __path__: {{ backup_log_path | default('/var/log/backup/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Performance logs
  - job_name: performance_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: performance_logs
          __path__: {{ performance_log_path | default('/var/log/performance/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Error logs
  - job_name: error_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: error_logs
          __path__: {{ error_log_path | default('/var/log/errors/*.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.*)$'
      - labels:
          level:

  # Homepage specific logs
  - job_name: homepage_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: homepage_logs
          __path__: {{ homepage_log_path | default('/var/log/homepage/*.log') }}
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            line: line
      - labels:
          level:
          logger:
          module:
          function: 