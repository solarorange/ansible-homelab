#!/bin/bash

# Pi-hole Backup Script
# Generated by Ansible

set -e

# Configuration
BACKUP_DIR="{{ backup_dir }}/pihole"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Backup Pi-hole configuration
docker exec pihole pihole -a -t > "$BACKUP_DIR/pihole_teleporter_$DATE.tar.gz"

# Backup custom lists and configurations
tar -czf "$BACKUP_DIR/pihole_config_$DATE.tar.gz" \
    "{{ docker_data_root }}/pihole/etc-pihole" \
    "{{ docker_data_root }}/pihole/etc-dnsmasq.d"

# Backup logs
tar -czf "$BACKUP_DIR/pihole_logs_$DATE.tar.gz" \
    "{{ docker_data_root }}/pihole/logs"

# Cleanup old backups
find "$BACKUP_DIR" -type f -name "pihole_*" -mtime +$RETENTION_DAYS -delete

# Log backup completion
echo "Pi-hole backup completed at $(date)" >> "$BACKUP_DIR/backup.log" 