---
# Configure notification channels
# Sets up AlertManager and notification templates

- name: Configure notification channels
  hosts: monitoring
  become: true
  gather_facts: false

  tasks:
    - name: Create notification templates directory
      file:
        path: /etc/alertmanager/template
        state: directory
        mode: '0755'
        owner: alertmanager
        group: alertmanager

    - name: Configure AlertManager
      template:
        src: templates/monitoring/alertmanager.yml.j2
        dest: /etc/alertmanager/alertmanager.yml
        owner: alertmanager
        group: alertmanager
        mode: '0644'
      notify: restart alertmanager

    - name: Create notification templates
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: alertmanager
        group: alertmanager
        mode: '0644'
      with_items:
        - { src: 'templates/notifications/email_test.j2', dest: '/etc/alertmanager/template/email.html' }
        - { src: 'templates/notifications/slack_test.j2', dest: '/etc/alertmanager/template/slack.json' }
        - { src: 'templates/notifications/discord_test.j2', dest: '/etc/alertmanager/template/discord.json' }
      notify: restart alertmanager

    - name: Restart AlertManager
      systemd:
        name: alertmanager
        state: restarted
        enabled: yes
      when: alertmanager_service_exists.stat.exists | default(false)
