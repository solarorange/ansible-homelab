---
# Nginx Proxy Manager Task - Enhanced Integration
# Integrates the enhanced NPM role with comprehensive automation and security

- name: Include Nginx Proxy Manager role
  ansible.builtin.include_role:
    name: nginx_proxy_manager
  become: true
  become_user: root
  tags: [nginx_proxy_manager, network, proxy]

- name: Validate Nginx Proxy Manager deployment
  ansible.builtin.include_tasks: validate.yml
  become: true
  become_user: root
  when: nginx_proxy_manager_enabled | default(true)
  tags: [nginx_proxy_manager, validation]

- name: Configure Nginx Proxy Manager integrations
  block:
    - name: Configure Authentik integration for NPM
      ansible.builtin.include_tasks: tasks/configure_authentik_integration.yml
      become: true
      become_user: root
      when: 
        - nginx_proxy_manager_enabled | default(true)
        - authentik_enabled | default(true)
      tags: [nginx_proxy_manager, authentik, integration]

    - name: Configure monitoring integration for NPM
      ansible.builtin.include_tasks: tasks/configure_monitoring_integration.yml
      become: true
      become_user: root
      when: 
        - nginx_proxy_manager_enabled | default(true)
        - grafana_enabled | default(true)
      tags: [nginx_proxy_manager, monitoring, integration]

    - name: Configure backup integration for NPM
      ansible.builtin.include_tasks: tasks/configure_backup_integration.yml
      become: true
      become_user: root
      when: 
        - nginx_proxy_manager_enabled | default(true)
        - backup_enabled | default(true)
      tags: [nginx_proxy_manager, backup, integration]

  when: nginx_proxy_manager_enabled | default(true)
  tags: [nginx_proxy_manager, integration]

- name: Display Nginx Proxy Manager deployment summary
  ansible.builtin.debug:
    msg: |
      ğŸš€ Nginx Proxy Manager Enhanced Deployment Complete!
      
      ğŸ“Š Deployment Summary:
      - Service Discovery: {{ nginx_proxy_manager_service_discovery_enabled | default(true) }}
      - Auto SSL: {{ nginx_proxy_manager_auto_ssl_enabled | default(true) }}
      - Security Headers: {{ nginx_proxy_manager_security_enabled | default(true) }}
      - Rate Limiting: {{ nginx_proxy_manager_rate_limiting_enabled | default(true) }}
      - WAF Rules: {{ nginx_proxy_manager_waf_enabled | default(true) }}
      - Monitoring: {{ nginx_proxy_manager_monitoring_enabled | default(true) }}
      - Backup: {{ nginx_proxy_manager_backup_enabled | default(true) }}
      
      ğŸ”— Access Information:
      - Admin URL: http://{{ ansible_default_ipv4.address }}:{{ nginx_proxy_manager_ports.admin | default(81) }}
      - Username: {{ vault_npm_admin_username | default('admin@' + domain) }}
      - API URL: {{ nginx_proxy_manager_api_url }}
      
      ğŸ” Security Features:
      - Vault Integration: âœ… Enabled
      - SSL Automation: âœ… Enabled
      - Service Discovery: âœ… Enabled
      - Security Headers: âœ… Enabled
      - Rate Limiting: âœ… Enabled
      - WAF Protection: âœ… Enabled
      
      ğŸ“ˆ Automation Features:
      - Service Discovery: {{ nginx_proxy_manager_discovery_services | default([]) | length }} services
      - SSL Provider: {{ nginx_proxy_manager_ssl_provider | default('letsencrypt') }}
      - Health Checks: {{ nginx_proxy_manager_health_check_enabled | default(true) }}
      - Cron Jobs: âœ… Scheduled
      
      ğŸ¯ Next Steps:
      1. Access NPM admin interface
      2. Review discovered services
      3. Verify SSL certificates
      4. Test security features
      5. Monitor automation logs
  when: nginx_proxy_manager_enabled | default(true)
  tags: [nginx_proxy_manager, info] 