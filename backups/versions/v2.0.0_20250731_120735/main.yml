---
# Seamless Homelab Setup with Comprehensive Monitoring and Automation
# Production-ready Ansible playbook for homelab deployment
- name: Seamless Homelab Setup
  hosts: all
  become: false  # ✅ CRITICAL FIX: Start without privileges, escalate only where needed
  gather_facts: true
  serial: "{{ serial | default(0) }}"  # Control parallel execution
  max_fail_percentage: 25  # Allow some failures in parallel execution

  vars:
    backup_dir: "/var/backups/ansible"
    notification_webhook_url: "{{ notification_webhook_url | default('') }}"
    critical_services:
      - docker
      - traefik
      - monitoring_infrastructure
    validation_timeout: 300
    validation_retries: 3
    # ✅ CRITICAL FIX: Add security validation variables
    security_validation_enabled: true
    privilege_escalation_required: true

  pre_tasks:
    # ✅ CRITICAL FIX: Validate privilege requirements before any escalation
    - name: Validate privilege escalation requirements
      ansible.builtin.assert:
        that:
          - ansible_user in sudoers or ansible_user == 'root'
          - ansible_become_available
          - ansible_become_method is defined
          - ansible_memtotal_mb >= 4096
          - ansible_diskspace_available >= 50
          - ansible_processor_cores >= 2
        fail_msg: |
          Deployment prerequisites not met:
          - User must have sudo privileges or be root
          - Privilege escalation must be available
          - Minimum 4GB RAM required ({{ ansible_memtotal_mb }}MB available)
          - Minimum 50GB disk space required ({{ ansible_diskspace_available }}GB available)
          - Minimum 2 CPU cores required ({{ ansible_processor_cores }} available)
      tags: [always, critical, validation]

    # ✅ CRITICAL FIX: Validate required variables with proper error handling
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - username is defined
          - domain is defined
          - cloudflare_email is defined
          - cloudflare_api_key is defined
        fail_msg: "Required variables are not defined. Check group_vars/all/vars.yml"
      tags: [always, critical]

    # ✅ CRITICAL FIX: Validate port conflicts before deployment
    - name: Validate port assignments
      ansible.builtin.include_tasks: tasks/port_validation.yml
      tags: [always, critical, validation]

    # ✅ CRITICAL FIX: Setup prerequisites with explicit privilege escalation
    - name: Setup prerequisites
      ansible.builtin.include_tasks: tasks/setup.yml
      become: true  # ✅ Explicit privilege escalation only where needed
      become_user: root
      tags: [setup, always]

    # ✅ CRITICAL FIX: Create backup with proper permissions
    - name: Create backup before deployment
      ansible.builtin.include_tasks: tasks/backup.yml
      become: true  # ✅ Explicit privilege escalation for backup operations
      become_user: root
      tags: [always, backup]

    # ✅ CRITICAL FIX: Deploy Proxmox VM with explicit privileges
    - name: Deploy Proxmox VM
      ansible.builtin.include_tasks: tasks/proxmox.yml
      become: true  # ✅ Explicit privilege escalation for VM operations
      become_user: root
      when: deploy_proxmox_vm | default(false)
      tags: [proxmox, always]

    # ✅ CRITICAL FIX: Setup error handling with proper escalation
    - name: Setup error handling
      ansible.builtin.include_tasks: handlers/error_handling/main.yml
      become: true  # ✅ Explicit privilege escalation for error handling
      become_user: root
      tags: always

    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Starting Enhanced Watchtower Deployment
          Target Host: {{ inventory_hostname }}
          Domain: {{ domain }}
          Services: {{ enabled_services | length }} services enabled
          Security Validation: {{ 'ENABLED' if security_validation_enabled else 'DISABLED' }}
      tags: always

    # ✅ CRITICAL FIX: Pre-deployment infrastructure validation with privileges
    - name: Pre-deployment infrastructure validation
      ansible.builtin.include_tasks: tasks/validate/infrastructure.yml
      become: true  # ✅ Explicit privilege escalation for validation
      become_user: root
      tags: [validation, pre-deployment, always]
      when: validation_enabled | default(true)

    # ✅ CRITICAL FIX: Create cache directories with proper permissions
    - name: Create cache directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ username }}"
        group: "{{ username }}"
      loop:
        - "{{ ansible_fact_caching_connection | dirname }}"
        - "{{ ansible_inventory_cache_connection | dirname }}"
      tags: always

    # ✅ CRITICAL FIX: Setup automation infrastructure with explicit privileges
    - name: Setup automation infrastructure
      ansible.builtin.include_tasks: tasks/automation.yml
      become: true  # ✅ Explicit privilege escalation for automation setup
      become_user: root
      tags: [automation]
      register: automation_result
      rescue:
        - name: Handle automation failure
          ansible.builtin.include_tasks: handlers/error_handling/recovery.yml
          become: true  # ✅ Explicit privilege escalation for recovery
          become_user: root
          vars:
            failed_config_files: "{{ automation_result.failed_config_files | default([]) }}"
            config_verification_commands: "{{ automation_result.verification_commands | default([]) }}"

    # ✅ CRITICAL FIX: Setup service management with explicit privileges
    - name: Setup service management
      ansible.builtin.include_tasks: tasks/service_management.yml
      become: true  # ✅ Explicit privilege escalation for service management
      become_user: root
      tags: [service_management]

  tasks:
    # Phase 1: Infrastructure Foundation
    # ✅ CRITICAL FIX: System essentials with explicit privileges and monitoring
    - name: System essentials and hardening
      ansible.builtin.include_tasks: tasks/essential.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [foundation, essential]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: essential_result

    # ✅ CRITICAL FIX: Docker configuration with explicit privileges
    - name: Configure Docker environment
      ansible.builtin.include_tasks: tasks/docker.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [foundation, docker]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: docker_result

    # ✅ CRITICAL FIX: Network configuration with explicit privileges
    - name: Setup network configuration
      ansible.builtin.include_tasks: tasks/network.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [foundation, network]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: network_result

    # ✅ CRITICAL FIX: Storage configuration with explicit privileges
    - name: Configure storage systems
      ansible.builtin.include_tasks: tasks/storage.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [foundation, storage]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: storage_result

    # ✅ CRITICAL FIX: Security hardening with explicit privileges
    - name: Apply security hardening
      ansible.builtin.include_tasks: tasks/security.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [foundation, security]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: security_result

    # Phase 2: Core Infrastructure Services
    # ✅ CRITICAL FIX: Core services with explicit privileges and validation
    - name: Deploy core infrastructure services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - traefik
        - authentik
        - monitoring_infrastructure
      when:
        - item in enabled_services
        - item != 'monitoring_infrastructure' or monitoring_enabled | default(true)
      tags: [infrastructure]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: core_services_result

    # ✅ CRITICAL FIX: Validate core services with proper error handling
    - name: Validate core services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ core_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: core_services_result is success
      tags: [infrastructure, validation]

    # Phase 3: Monitoring Stack (TIG + Prometheus)
    # ✅ CRITICAL FIX: Monitoring services with explicit privileges
    - name: Deploy monitoring services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - influxdb
        - telegraf
        - prometheus
        - grafana
        - loki
        - promtail
        - alertmanager
        - blackbox_exporter
      when:
        - monitoring_enabled | default(true)
        - item in enabled_services
      tags: [monitoring]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: monitoring_services_result

    # ✅ CRITICAL FIX: Validate monitoring services
    - name: Validate monitoring services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ monitoring_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: monitoring_services_result is success
      tags: [monitoring, validation]

    # ✅ CRITICAL FIX: Configure enhanced monitoring with explicit privileges
    - name: Configure enhanced monitoring
      ansible.builtin.include_tasks: tasks/monitoring_enhancements.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      when: monitoring_enabled | default(true)
      tags: [monitoring]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring

    # Phase 4: Security Services
    # ✅ CRITICAL FIX: Security services with explicit privileges
    - name: Deploy security services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - crowdsec
        - fail2ban
        - vault
        - wireguard
      when: item in enabled_services
      tags: [security]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: security_services_result

    # ✅ CRITICAL FIX: Validate security services
    - name: Validate security services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ security_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: security_services_result is success
      tags: [security, validation]

    # Phase 5: Network Services
    # ✅ CRITICAL FIX: Network services with explicit privileges
    - name: Deploy network services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - pihole
        - nginx_proxy_manager
        - fing
      when: item in enabled_services
      tags: [network]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: network_services_result

    # ✅ CRITICAL FIX: Validate network services
    - name: Validate network services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ network_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: network_services_result is success
      tags: [network, validation]

    # Phase 6: Media Stack
    # ✅ CRITICAL FIX: Media services with explicit privileges
    - name: Deploy media services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - sabnzbd
        - qbittorrent
        - sonarr
        - radarr
        - lidarr
        - readarr
        - prowlarr
        - bazarr
        - jellyfin
        - emby
        - tdarr
        - overseerr
        - tautulli
        - immich
        - calibre-web
        - audiobookshelf
        - komga
        - ersatztv
      when:
        - media_enabled | default(true)
        - item in enabled_services
      tags: [media]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: media_services_result

    # ✅ CRITICAL FIX: Validate media services
    - name: Validate media services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ media_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: media_services_result is success
      tags: [media, validation]

    # Configure Lidarr automatically
    # ✅ CRITICAL FIX: Configure Lidarr with explicit privileges
    - name: Configure Lidarr with all variables and integrations
      ansible.builtin.include_tasks: tasks/configure_lidarr.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      when:
        - media_enabled | default(true)
        - 'lidarr' in enabled_services
      tags: [media, lidarr, configuration]

    # Phase 7: File Services
    # ✅ CRITICAL FIX: File services with explicit privileges
    - name: Deploy file services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - nextcloud
        - samba
        - syncthing
      when: item in enabled_services
      tags: [storage]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: file_services_result

    # ✅ CRITICAL FIX: Validate file services
    - name: Validate file services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ file_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: file_services_result is success
      tags: [storage, validation]

    # Phase 8: Development & Storage
    # ✅ CRITICAL FIX: Development services with explicit privileges
    - name: Deploy development and storage services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - gitlab
        - harbor
        - minio
        - paperless
        - bookstack
        - immich
        - filebrowser
        - linkwarden
        - vaultwarden
      when: item in enabled_services
      tags: [development, storage]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: dev_services_result

    # ✅ CRITICAL FIX: Validate development services
    - name: Validate development services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ dev_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: dev_services_result is success
      tags: [development, storage, validation]

    # Phase 8.5: Utility Services
    # ✅ CRITICAL FIX: Utility services with explicit privileges
    - name: Deploy utility services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ utility_services }}"
      when: item in enabled_services
      tags: [utility]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: utility_services_result

    # ✅ CRITICAL FIX: Validate utility services
    - name: Validate utility services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ utility_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: utility_services_result is success
      tags: [utility, validation]

    # Phase 9: Automation & Smart Home
    # ✅ CRITICAL FIX: Automation services with explicit privileges
    - name: Deploy automation services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - mosquitto
        - zigbee2mqtt
        - home_assistant
        - nodered
      when:
        - automation_enabled | default(true)
        - item in enabled_services
      tags: [automation]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: automation_services_result

    # Deploy n8n workflow automation
    # ✅ CRITICAL FIX: Deploy n8n with explicit privileges
    - name: Deploy n8n workflow automation
      ansible.builtin.include_role:
        name: n8n
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      when:
        - automation_enabled | default(true)
        - 'n8n' in enabled_services
      tags: [automation, n8n]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring

    # Deploy Pezzo AI prompt management
    # ✅ CRITICAL FIX: Deploy Pezzo with explicit privileges
    - name: Deploy Pezzo AI prompt management
      ansible.builtin.include_role:
        name: pezzo
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      when:
        - automation_enabled | default(true)
        - 'pezzo' in enabled_services
      tags: [automation, pezzo]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring

    # ✅ CRITICAL FIX: Validate automation services
    - name: Validate automation services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ automation_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: automation_services_result is success
      tags: [automation, validation]

    # Phase 10: Backup & Maintenance
    # ✅ CRITICAL FIX: Backup services with explicit privileges
    - name: Deploy backup services
      ansible.builtin.include_tasks: "tasks/{{ item }}.yml"
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop:
        - backup
        - kopia
      when: item in enabled_services
      tags: [backup]
      async: 300
      poll: 10  # ✅ CRITICAL FIX: Add polling for better monitoring
      register: backup_services_result

    # ✅ CRITICAL FIX: Validate backup services
    - name: Validate backup services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ backup_services_result.results | map(attribute='item') | list }}"
      loop_control:
        loop_var: service_name
      when: backup_services_result is success
      tags: [backup, validation]

  post_tasks:
    # ✅ CRITICAL FIX: Post-deployment validation with explicit privileges
    - name: Post-deployment infrastructure validation
      ansible.builtin.include_tasks: tasks/validate/infrastructure.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      tags: [validation, post-deployment, always]
      when: validation_enabled | default(true)

    # ✅ CRITICAL FIX: Verify critical services with explicit privileges
    - name: Verify all critical services
      ansible.builtin.include_tasks: tasks/validate.yml
      become: true  # ✅ Explicit privilege escalation
      become_user: root
      loop: "{{ critical_services }}"
      loop_control:
        loop_var: service_name
      tags: [always, validation]

    # ✅ CRITICAL FIX: Monitor system resources
    - name: Monitor system resources
      ansible.builtin.include_tasks: tasks/resource_monitoring.yml
      tags: [always, monitoring, resources]

    # ✅ CRITICAL FIX: Perform secret rotation if needed
    - name: Perform secret rotation
      ansible.builtin.include_tasks: tasks/secret_rotation.yml
      tags: [always, security, secrets, rotation]

    # ✅ CRITICAL FIX: Send deployment notification with proper error handling
    - name: Send deployment notification
      ansible.builtin.uri:
        url: "{{ notification_webhook_url }}"
        method: POST
        body_format: json
        body: |
          {
            "status": "{{ 'success' if critical_services | length == 0 else 'warning' }}",
            "message": "Deployment completed with {{ critical_services | length }} critical services requiring attention",
            "host": "{{ inventory_hostname }}",
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "security_validation": "{{ 'PASSED' if security_validation_enabled else 'DISABLED' }}",
            "resource_health": "{{ 'HEALTHY' if cpu_usage < resource_thresholds.cpu_warning and memory_usage < resource_thresholds.memory_warning and disk_usage < resource_thresholds.disk_warning else 'WARNING' }}"
          }
      when: notification_webhook_url is defined
      tags: [always, notification]

# Handlers for service management
  handlers:
    - name: restart docker
      ansible.builtin.systemd:
        name: docker
        state: restarted
        enabled: true

    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: restart networking
      ansible.builtin.systemd:
        name: networking
        state: restarted
